 
<html build-time="2020-12-01 00:19">
  <head>
    <title>Laravel 使用 JWT 实现用户认证</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2235676_71rm12z746w.css">
    <link rel="stylesheet" href="/libs/prism/prism.default.css">
    <link rel="stylesheet" href="/css/index.css?t=202012010019">
  <meta name="generator" content="Hexo 5.2.0"></head>
  <body ontouchstart="">
    <div class="head">
  <div class="header">
    <div class="title">
      <a href="/"></a>ymcai</a>
    </div>
    <div class="menu">
      <a href="/">
        <span class="menu-item">首页</span>
      </a>
      <a href="/categories">
        <span class="menu-item">分类</span>
      </a>
      <a href="/about">
        <span class="menu-item">关于</span>
      </a>
    </div>
  </div>
</div>
    <div class="body">
  <div class="container">
     

<div class="post-header">
  <h1 class="post-title">Laravel 使用 JWT 实现用户认证</h1>
  <div class="post-meta">
    <span>2017-06-11</span>
    
      
      <a class="post-meta-category" href="/categories/categories/back-end">后端</a>
    
  </div>
</div>
<div class="post-body main-body">
  <p>JWT（JSON Web Token）是一个用于安全信息传输的开放标准。基于 JWT 的用户认证，用户只需登录一次，服务端生成 Token（令牌）并发送给客户端，客户端则在每次发送请求时携带该 Token ，服务端根据 Token 识别用户身份。</p>
<a id="more"></a>

<p>一个 JSON Web Token 是用 base64 编码的长字符串，包含了验证用户身份所需的必要信息。</p>
<pre class="line-numbers language-none"><code class="language-none">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxIiwiaXNzIjoiaHR0cDpcL1wvbG9jYWx
ob3N0OjgwMDFcL2F1dGhcL2xvZ2luIiwiaWF0IjoxNDUxODg4MTE5LCJleHAiOjE0NTQ1MTYxMTksIm5iZiI6MTQ1MTg4OD
ExOSwianRpIjoiMzdjMTA3ZTQ2MDlkZGJjYzljMDk2ZWE1ZWU3NmM2NjcifQ.wyoQ95RjAyQ2FF3aj8EvCSaUmeP0KUqcCJDENNfnaT4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这里对 JWT 规范不加赘述，只讨论如何快速实现基于 JWT 的用户认证。如果想进一步了解 JWT 规范，建议阅读 <a target="_blank" rel="noopener" href="https://jwt.io/">官方文档</a> 。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>使用 Composer 安装 jwt-auth 依赖包。</p>
<pre class="line-numbers language-none"><code class="language-none">composer require tymon&#x2F;jwt-auth 0.5.*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>在 <code>config\app.php</code> 配置文件中，注册服务提供者和门面。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token single-quoted-string string">'providers'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  Tymon\<span class="token package">JWTAuth<span class="token punctuation">\</span>Providers<span class="token punctuation">\</span>JWTAuthServiceProvider</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token single-quoted-string string">'aliases'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token single-quoted-string string">'JWTAuth'</span> <span class="token operator">=</span><span class="token operator">></span> Tymon\<span class="token package">JWTAuth<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>JWTAuth</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
  <span class="token single-quoted-string string">'JWTFactory'</span> <span class="token operator">=</span><span class="token operator">></span> Tymon\<span class="token package">JWTAuth<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>JWTFactory</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行以下命令发布 JWT 配置文件。该命令将在 <code>config</code> 目录下生成 <code>jwt.php</code> ，通常使用默认配置即可。</p>
<pre class="line-numbers language-none"><code class="language-none">php artisan vendor:publish --provider&#x3D;&quot;Tymon\JWTAuth\Providers\JWTAuthServiceProvider&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>生成用于加密数据的密钥。</p>
<pre class="line-numbers language-none"><code class="language-none">php artisan jwt:generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><p>引用 <code>JWTAuth</code> 门面和异常处理类。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">JWTAuth</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Tymon<span class="token punctuation">\</span>JWTAuth<span class="token punctuation">\</span>Exceptions<span class="token punctuation">\</span>JWTException</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>使用请求中的登录凭据（通常是邮箱和密码）创建 Token 。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// 获取请求中的登录凭据</span>
  <span class="token variable">$credentials</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">only</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 验证登录凭据并创建 Token</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$token</span> <span class="token operator">=</span> JWTAuth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">attempt</span><span class="token punctuation">(</span><span class="token variable">$credentials</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 登录凭据无效时返回错误</span>
      <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'error'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'invalid_credentials'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>JWTException <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 无法正常生成 Token 时返回错误</span>
    <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'error'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'could_not_create_token'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 返回创建的 Token</span>
  <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>登录凭据也可以是任何用户表里存在的字段，譬如手机号和密码。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$credentials</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">only</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'mobile'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们还可以直接基于用户模型对象创建 Token ，满足更为个性化的认证需求。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$token</span> <span class="token operator">=</span> JWTAuth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fromUser</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token variable">$token</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>在 <code>app\Http\Kernel.php</code> 中注册 JWT 提供的认证中间件。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token variable">$routeMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token single-quoted-string string">'jwt.auth'</span> <span class="token operator">=</span><span class="token operator">></span> \<span class="token package">Tymon<span class="token punctuation">\</span>JWTAuth<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>GetUserFromToken</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>对需要认证才能访问的路由启用该中间件。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'middleware'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'jwt.auth'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>jwt.auth</code> 中间件将会解析请求中携带的 Token 。如果找不到 Token ，则返回“token_not_provided”错误；如果 Token 已过期，则返回“token_expired”错误。</p>
<p>客户端在请求的头部信息或 URL 中携带有效的 Token 即可通过认证。</p>
<pre class="line-numbers language-none"><code class="language-none">Authorization: Bearer &#123; Token &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;api.example.com&#x2F;example?token&#x3D;&#123; Token &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>服务端可以从 Token 中获得用户对象。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$user</span> <span class="token operator">=</span> JWTAuth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parseToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>相关环境：Windows 7 x64 / VirtualBox 5.1.8 / Laravel Homestead / Laravel 5.4</p>

  
    <div class="post-tags">
    
      
      <a class="post-tag" href="/tags/Laravel">Laravel</a>
    
      
      <a class="post-tag" href="/tags/JWT">JWT</a>
    
      
      <a class="post-tag" href="/tags/API">API</a>
    
  </div>
  
</div>
<div class="page-footer">
  <div class="page-footer-links">
    <a class="page-footer-link" href="javascript:history.back()">返回</a>
    
      <a class="page-footer-link" href="">
        下一篇：gulp 小教程
      </a>
     
  </div>
</div>

  </div>
</div>
    <div class="foot">
  <div class="footer">
    <span class="copyright">©️2020 ymcai.xyz</span>
    <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
  </div>
</div>

<script type="text/javascript">
function wrapTables() {
  var nodes = document.body.querySelectorAll('table');
  for (var i = 0; i < nodes.length; i++) {
    var table = nodes[i];
    var wrapEl = document.createElement('div');
    wrapEl.className = 'table-wrap';
    table.parentNode.replaceChild(wrapEl, table);
    wrapEl.appendChild(table)
  }
};
wrapTables();
</script>
  </body>
</html>