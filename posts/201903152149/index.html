 
<html>
  <head>
    <title>Promise 的原理与简单实现</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2235676_71rm12z746w.css">
    <link rel="stylesheet" href="/libs/prism/prism.default.css">
    <link rel="stylesheet" href="/css/index.css">
  <meta name="generator" content="Hexo 5.2.0"></head>
  <body ontouchstart="">
    <div class="head">
  <div class="header">
    <div class="title">
      <a href="/"></a>ymcai</a>
    </div>
    <div class="menu">
      <a href="/">
        <span class="menu-item">首页</span>
      </a>
      <a href="/categories">
        <span class="menu-item">分类</span>
      </a>
      <a href="/about">
        <span class="menu-item">关于</span>
      </a>
    </div>
  </div>
</div>
    <div class="body">
  <div class="container">
     

<div class="post-header">
  <h1 class="post-title">Promise 的原理与简单实现</h1>
  <div class="post-meta">
    <span>2019-03-15</span>
    
      
      <a class="post-meta-category" href="/categories/categories/web-front-end">Web 前端</a>
    
  </div>
</div>
<div class="post-body main-body">
  <h2 id="什么是-Promise"><a href="#什么是-Promise" class="headerlink" title="什么是 Promise"></a>什么是 Promise</h2><p>起初，人们使用回调函数进行异步编程。回调函数是指一个可被另一个函数访问，并在后者执行后调用的函数。过多的回调函数嵌套形成难以阅读和维护的回调地狱（Callback Hell / Pyramid of Doom）。</p>
<a id="more"></a>

<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token function">login</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">getProductList</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">...</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这时候人们开始思考更佳的异步解决方案，Promise 应运而生。</p>
<p><code>promise</code> 这个词的原意是约定。在现实生活中，约定往往不是立即做一件事，而是在满足一定条件下做或不做某事。</p>
<p>电影《泰坦尼克号》中杰克对罗斯说“你跳，我也跳（You jump, I jump）”。由于杰克不知道罗斯跳不跳，何时跳，后者的行为可以视为一个需要等待的异步操作。罗斯的行为可能从犹豫到跳，或者从犹豫到不跳。杰克准备好了两种情况的应对方案。所以杰克说的话实际上声明了一个 Promise。</p>
<p>Promise 是一个表示异步操作的最终结果的对象。它帮助我们跟进异步操作的状态，并根据结果执行不同的代码。</p>
<p>在 ES6 中我们通常会这样使用 Promise ：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 异步操作 ...</span>
  <span class="token comment">// 如果操作完成</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token comment">// 否则</span>
  <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 完成</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 拒绝或抛出异常</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Promise 的构造函数接收一个立即执行的函数 <code>executor</code>，这个函数通常包含异步操作。<code>executor</code> 的两个参数 <code>resolve</code> 和 <code>reject</code> 函数用于更新 Promise 的状态。</p>
<p><code>then</code> 方法注册完成时的回调，该回调函数能够访问终值 <code>value</code>（如果有）。<code>catch</code> 方法注册拒绝时的回调，该回调函数能够访问拒绝的原因 <code>error</code>（如果有）。Promise 的状态更新后，相应的回调函数将被执行。</p>
<h2 id="Promise-A-规范"><a href="#Promise-A-规范" class="headerlink" title="Promise/A+ 规范"></a>Promise/A+ 规范</h2><p>Promise 最早由社区提出，后来逐渐形成了几种规范。目前较权威的规范是 <a target="_blank" rel="noopener" href="https://promisesaplus.com/">Promise/A+</a> ，ES6 正是遵循此规范实现，使 Promise 正式成为了 JavaScript 标准的一部分。</p>
<p>简单的说一个 Promise：</p>
<ol>
<li>存在三种状态：pending 表示异步操作尚未结束，fulfilled 表示完成（成功），rejected 表示拒绝（失败）。</li>
<li>状态的改变只能从 pending 到 fulfilled / rejected 。人生无法重来，Promise 也一样。</li>
<li>必须提供一个 <code>then</code> 方法用于注册回调函数。</li>
<li>完成时有一个终值（eventual value），拒绝时有一个不能完成的原因（reason）。</li>
</ol>
<p>经常使用 ES6 Promise 的同学应该会注意到，ES6 使用 resolved 状态替代了标准中的 fulfilled ，并且实现了标准中没有要求的 <code>catch</code>、<code>all</code> 等实用特性。</p>
<p>此外，规范并没有说明 Promise 对象如何产生。ES6 使用构造函数创建 Promise 对象。</p>
<h2 id="实现基础的-Promise"><a href="#实现基础的-Promise" class="headerlink" title="实现基础的 Promise"></a>实现基础的 Promise</h2><p>根据前述规范实现一个基础的 Promise 构造函数：</p>
<pre class="line-numbers language-JS" data-language="JS"><code class="language-JS">function MyPromise (executor) &#123;

  var that &#x3D; this

  &#x2F;&#x2F; 初始状态为 pending
  this.status &#x3D; &#39;pending&#39;

  this.onFulfilled &#x3D; null
  this.onRejected &#x3D; null

  &#x2F;&#x2F; 用于注册完成和拒绝回调的实例方法 then
  this.then &#x3D; function (onFulfilled, onRejected) &#123;
    this.onFulfilled &#x3D; onFulfilled
    this.onRejected &#x3D; onRejected
  &#125;

  &#x2F;&#x2F; 完成时执行的局部函数 fulfill
  function fulfill (eventualValue) &#123;
    if (that.status &#x3D;&#x3D;&#x3D; &#39;pending&#39;) &#123;
      that.status &#x3D; &#39;fulfiled&#39;
      typeof that.onFulfilled &#x3D;&#x3D;&#x3D; &#39;function&#39; &amp;&amp; that.onFulfilled(eventualValue)
    &#125;
  &#125;

  &#x2F;&#x2F; 拒绝时执行的局部函数 reject
  function reject (reason) &#123;
    if (that.status &#x3D;&#x3D;&#x3D; &#39;pending&#39;) &#123;
      that.status &#x3D; &#39;rejected&#39;
      typeof that.onRejected &#x3D;&#x3D;&#x3D; &#39;function&#39; &amp;&amp; that.onRejected(reason)
    &#125;
  &#125;

  &#x2F;&#x2F; 实例化时立即执行的函数 executor
  executor(fulfill, reject)

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后可以这样使用 MyPromise：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fulfill<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 异步操作 ...</span>
  <span class="token comment">// 如果操作完成</span>
  <span class="token function">fulfill</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
  <span class="token comment">// 否则</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Some reasons'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Eventual Value: '</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token parameter">reason</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="增加链式调用"><a href="#增加链式调用" class="headerlink" title="增加链式调用"></a>增加链式调用</h2><p>你可能注意到，通过上面的构造函数创建的 Promise 只能注册一个完成回调，并不支持这样的链式调用：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 第一个回调</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 第二个回调</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此需要稍作改进：</p>
<ol>
<li>为了存储多个回调函数，<code>onFulfilled</code> 属性应该是一个数组，每次调用 <code>then</code> 方法都追加一个回调函数。</li>
<li><code>then</code> 方法返回当前 promise 实例，以实现链式调用。（事实上也是规范的要求）</li>
<li>完成时执行 <code>onFulfilled</code> 数组中的所有函数。</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilled <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilled<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onRejected <span class="token operator">=</span> onRejected
  <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">fulfill</span> <span class="token punctuation">(</span><span class="token parameter">eventualValue</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    that<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'fulfiled'</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> that<span class="token punctuation">.</span>onFulfilled<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">typeof</span> that<span class="token punctuation">.</span>onFulfilled<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> that<span class="token punctuation">.</span>onFulfilled<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>eventualValue<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="增加-catch-方法"><a href="#增加-catch-方法" class="headerlink" title="增加 catch 方法"></a>增加 catch 方法</h2><p>接下来实现一个类似 ES6 Promise 的 <code>catch</code> 方法。</p>
<p><code>catch</code> 方法可以注册拒绝回调，行为类似 <code>then(null, onRejected)</code> ，同时可以处理 <code>executor</code> 抛出的错误。</p>
<p>首先增加一个 <code>catch</code> 方法：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>onRejected <span class="token operator">=</span> onRejected
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后修改执行 <code>executor</code> 的语句。使用 <code>try...catch</code> 语句捕获错误，并在出错时执行 <code>onRejected</code> 方法。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>fulfill<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> that<span class="token punctuation">.</span>onRejected <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> that<span class="token punctuation">.</span><span class="token function">onRejected</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token keyword">else</span> <span class="token keyword">throw</span> e
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>包裹 <code>setTimeout</code> 的目的是延迟执行，确保执行 <code>executor</code> 时失败回调已经注册完毕。</p>
<h2 id="实现-Promise-all"><a href="#实现-Promise-all" class="headerlink" title="实现 Promise.all"></a>实现 Promise.all</h2><p>前面实现的 Promise 已经可以胜任“等一件事完成再做另一件事”的工作。那如果我们要等两件甚至更多件事完成，最后再做某事呢？比如做菜时等菜切好、油烧热再下锅。</p>
<p>ES6 中实现的 <code>Promise.all</code> 接收一个数组，返回一个 Promise 实例。这个实例在数组内所有 <code>promise</code> 完成时才会完成，任何一个 <code>promise</code> 拒绝都将导致其拒绝。</p>
<p>下面的代码实现了一个 <code>all</code> 方法：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">MyPromise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fulfill<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">function</span> <span class="token function">next</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      promises<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        index<span class="token operator">++</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token function">fulfill</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://github.com/ymcn/promise">点此</a> 查看完整代码示例。</p>

  
    <div class="post-tags">
    
      
      <a class="post-tag" href="/tags/JavaScript">JavaScript</a>
    
      
      <a class="post-tag" href="/tags/ES6">ES6</a>
    
      
      <a class="post-tag" href="/tags/Promise">Promise</a>
    
  </div>
  
</div>
<div class="page-footer">
  <div class="page-footer-links">
    <a class="page-footer-link" href="javascript:history.back()">返回</a>
    
      <a class="page-footer-link" href="">
        下一篇：Android 应用接入微信分享
      </a>
     
  </div>
</div>

  </div>
</div>
    <div class="foot">
  <div class="footer">
    <span class="copyright">©️2020 ymcai.xyz</span>
    <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
  </div>
</div>

<script type="text/javascript">
function wrapTables() {
  var nodes = document.body.querySelectorAll('table');
  for (var i = 0; i < nodes.length; i++) {
    var table = nodes[i];
    var wrapEl = document.createElement('div');
    wrapEl.className = 'table-wrap';
    table.parentNode.replaceChild(wrapEl, table);
    wrapEl.appendChild(table)
  }
};
wrapTables();
</script>
  </body>
</html>