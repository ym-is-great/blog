 
<html>
  <head>
    <title>如何优雅地和译者协作开发多语言 WebApp</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2235676_71rm12z746w.css">
    <link rel="stylesheet" href="/libs/prism/prism.default.css">
    <link rel="stylesheet" href="/css/index.css">
  <meta name="generator" content="Hexo 5.2.0"></head>
  <body ontouchstart="">
    <div class="head">
  <div class="header">
    <div class="title">
      <a href="/"></a>ymcai</a>
    </div>
    <div class="menu">
      <a href="/">
        <span class="menu-item">首页</span>
      </a>
      <a href="/categories">
        <span class="menu-item">分类</span>
      </a>
      <a href="/about">
        <span class="menu-item">关于</span>
      </a>
    </div>
  </div>
</div>
    <div class="body">
  <div class="container">
     

<div class="post-header">
  <h1 class="post-title">如何优雅地和译者协作开发多语言 WebApp</h1>
  <div class="post-meta">
    <span>2018-06-10</span>
    
      
      <a class="post-meta-category" href="/categories/categories/web-front-end">Web 前端</a>
    
  </div>
</div>
<div class="post-body main-body">
  <p>因为工作需要，未来开发的大部分 WebApp、H5 都需要国际化。现有工作流程比较简单：不同国家的译者在 Google Docs 的表格上翻译，开发者手动拷贝文本到前端项目中。对开发而言，由于看不懂文档中的大多数语言，既费时费力又容易出错。</p>
<a id="more"></a>

<p>所以我迫切需要一个能优化流程的工具。首先要使翻译的同事们不需要做太多改变 —— 总不能强求非开发人员学习 JSON 吧，又必须能让我显著减少浪费在拷贝和校对文本上的时间，专注于功能开发。</p>
<p>于是我写了一个叫 i18nCSV 的工具，主要做几件事情：</p>
<ul>
<li>解析 CSV 翻译文件</li>
<li>返回多语言 Object</li>
<li>输出各个语言的 <code>.json</code>、<code>.yml</code> 文件</li>
<li>字符串处理</li>
</ul>
<p>译者仍然在 Google Docs 上工作，我只需把表格存为 CSV 格式再用工具跑一下，就能得到我要的东西。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-none"><code class="language-none">npm install i18n-csv --save-dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>CSV 文件内容：</p>
<table>
<thead>
<tr>
<th>Field name</th>
<th>en</th>
<th>zh-cn</th>
<th>jp</th>
</tr>
</thead>
<tbody><tr>
<td>title</td>
<td>Hello World</td>
<td>你好世界</td>
<td>こんにちは世界</td>
</tr>
<tr>
<td>subtitle</td>
<td>The weather is great !</td>
<td>天气真好!</td>
<td>天_はとても良いです！</td>
</tr>
</tbody></table>
<p>使用 i18nCSV 解析：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> i18nCSV <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'i18n-csv'</span><span class="token punctuation">)</span>
i18nCSV<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> input<span class="token operator">:</span> <span class="token string">'./file1.csv'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>返回的对象：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token punctuation">&#123;</span>
  en<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    title<span class="token operator">:</span> <span class="token string">'Hello World'</span><span class="token punctuation">,</span>
    subtitle<span class="token operator">:</span> <span class="token string">'The weather is great !'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">'zh-cn'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    title<span class="token operator">:</span> <span class="token string">'你好世界'</span><span class="token punctuation">,</span>
    subtitle<span class="token operator">:</span> <span class="token string">'天气真好!'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  jp<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    title<span class="token operator">:</span> <span class="token string">'こんにちは世界'</span><span class="token punctuation">,</span>
    subtitle<span class="token operator">:</span> <span class="token string">'天_はとても良いです！'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="设置起始列"><a href="#设置起始列" class="headerlink" title="设置起始列"></a>设置起始列</h2><p>默认使用第 2 行为正文的起始行，第 2 列作为正文的起始列。</p>
<p>有时我们需要指定正文的起始列。例如，为了和翻译人员协作，我们需要在正文前面插入两列描述内容，但是不希望这两列被当作语言解析到对象中。</p>
<p>CSV 文件内容：</p>
<table>
<thead>
<tr>
<th>Field name</th>
<th>Description (Chinese)</th>
<th>Description (English)</th>
<th>en</th>
<th>zh-cn</th>
<th>jp</th>
</tr>
</thead>
<tbody><tr>
<td>title</td>
<td>标题</td>
<td>main title</td>
<td>Hello World</td>
<td>你好世界</td>
<td>こんにちは世界</td>
</tr>
<tr>
<td>subtitle</td>
<td>副标题</td>
<td>subtitle</td>
<td>The weather is great !</td>
<td>天气真好!</td>
<td>天_はとても良いです！</td>
</tr>
</tbody></table>
<p>此时可以使用 <code>startCol=4</code> 指定正文从第 4 列开始：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">i18nCSV<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  input<span class="token operator">:</span> <span class="token string">'./file2.csv'</span><span class="token punctuation">,</span>
  startCol<span class="token operator">:</span> <span class="token number">4</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>类似的，使用 <code>startRow</code> 可以设置正文的起始行。</p>
<h2 id="设置语言代码"><a href="#设置语言代码" class="headerlink" title="设置语言代码"></a>设置语言代码</h2><p>默认使用正文的列标题（第一行）作为语言代码：<code>en</code>、<code>zh-cn</code>、<code>jp</code>，并用作输出的文件名：<code>en.json</code>、<code>zh-cn.json</code>、<code>jp.json</code>。</p>
<p>当需要和其他同事，比如翻译或运营人员协作时，列标题应该更加友好、通俗易懂。此时可以用 <code>#</code> 设置语言代码。列标题中包含多个 <code>#</code> 时将始终使用最后一个 <code>#</code> 后的内容作为语言代码。</p>
<p>示例：</p>
<table>
<thead>
<tr>
<th>Field name</th>
<th>English #en</th>
<th>Chinese #zh-cn</th>
<th>Japanese #jp</th>
</tr>
</thead>
<tbody><tr>
<td>title</td>
<td>Hello World</td>
<td>你好世界</td>
<td>こんにちは世界</td>
</tr>
<tr>
<td>subtitle</td>
<td>The weather is great !</td>
<td>天气真好!</td>
<td>天_はとても良いです！</td>
</tr>
</tbody></table>
<h2 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h2><p>使用 <code>ouput</code> 指定输出目录，解析后会在目录下生成各个语言的 <code>.json</code> 文件。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">i18nCSV<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  input<span class="token operator">:</span> <span class="token string">'./file1.csv'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token string">'path/to/output'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出完毕打印的日志：</p>
<pre class="line-numbers language-none"><code class="language-none">Multi-language files has been generated !

source:  .&#x2F;file1.csv
output:  path&#x2F;to&#x2F;output
format:  JSON<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如无意外，<code>path/to/output</code> 目录下已经新增了 <code>en.json</code> 、<code>zh-cn.json</code> 、<code>jp.json</code> 三个文件。</p>
<p>生成的 <code>en.json</code> 文件内容：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// path/to/output/en.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">,</span>
  <span class="token property">"subtitle"</span><span class="token operator">:</span> <span class="token string">"The weather is great !"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用 <code>saveAsYAML=true</code> 可以输出更简洁、易于修改的 YAML 格式：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">i18nCSV<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  input<span class="token operator">:</span> <span class="token string">'./file1.csv'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token string">'path/to/output'</span><span class="token punctuation">,</span>
  saveAsYAML<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>生成的 <code>en.yml</code> 文件内容：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># path/to/output/en.yml</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> Hello World
<span class="token key atrule">subtitle</span><span class="token punctuation">:</span> The weather is great <span class="token tag">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h2 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h2><p>假设有 CSV 文件内容如下：</p>
<table>
<thead>
<tr>
<th>Field name</th>
<th>en</th>
<th>zh-cn</th>
<th>jp</th>
</tr>
</thead>
<tbody><tr>
<td>title</td>
<td>Hello World</td>
<td>你好世界</td>
<td>こんにちは世界</td>
</tr>
<tr>
<td>subtitle</td>
<td>Share trips with #trips</td>
<td>参与话题 #trips 分享旅程</td>
<td>#trips とのシェアトリップ</td>
</tr>
</tbody></table>
<p>为了自定义文本中的 <em>#trips</em>  的样式，我们需要对文本进行一些处理。</p>
<p><code>replace</code> 用于添加 __替换任务__，它的每一个元素都是一个任务。任务（数组）的第一个元素是被替换内容，可以是正则表达式或字符串，第二个元素是替换内容。</p>
<p>例如，将所有 <code>#trips</code> 用 <code>&lt;hashtag&gt;</code> 标签包裹起来：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">i18nCSV<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  input<span class="token operator">:</span> <span class="token string">'./file4.csv'</span><span class="token punctuation">,</span>
  replace<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(#\w+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&lt;hashtag>$1&lt;/hashtag>'</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>返回的对象：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token punctuation">&#123;</span>
  en<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    title<span class="token operator">:</span> <span class="token string">'Hello World'</span><span class="token punctuation">,</span>
    subtitle<span class="token operator">:</span> <span class="token string">'Share trips with &lt;hashtag>#trips&lt;/hashtag>'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">'zh-cn'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    title<span class="token operator">:</span> <span class="token string">'你好世界'</span><span class="token punctuation">,</span>
    subtitle<span class="token operator">:</span> <span class="token string">'参与话题 &lt;hashtag>#trips&lt;/hashtag> 分享旅程'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  jp<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    title<span class="token operator">:</span> <span class="token string">'こんにちは世界'</span><span class="token punctuation">,</span>
    subtitle<span class="token operator">:</span> <span class="token string">'&lt;hashtag>#trips&lt;/hashtag> とのシェアトリップ'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>任务的第三个元素可以指定仅对某个字段有效：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">i18nCSV<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  input<span class="token operator">:</span> <span class="token string">'./file4.csv'</span><span class="token punctuation">,</span>
  replace<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(#\w+)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&lt;hashtag>$1&lt;/hashtag>'</span><span class="token punctuation">,</span> <span class="token string">'subtitle'</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2><ol>
<li>CSV 文件的第一列始终作为每一行文本的 Key 。</li>
<li>CSV 文件的编码必须是 UTF-8 ，否则可能出现解析后的内容包含乱码。Mac 下转换编码：使用 Numbers 打开 CSV 文件，点击菜单中的 文件 &gt; 导出到 &gt; CSV，在 <em>高级选项</em> 中将 <em>文本编码</em> 修改为 <em>UTF-8</em> 后导出。</li>
</ol>
<p>相关环境：macOS 10.13 / Node.js 8.11 / npm 5.6</p>

  
    <div class="post-tags">
    
      
      <a class="post-tag" href="/tags/JSON">JSON</a>
    
      
      <a class="post-tag" href="/tags/Node.js">Node.js</a>
    
      
      <a class="post-tag" href="/tags/i18n">i18n</a>
    
      
      <a class="post-tag" href="/tags/CSV">CSV</a>
    
      
      <a class="post-tag" href="/tags/YAML">YAML</a>
    
  </div>
  
</div>
<div class="page-footer">
  <div class="page-footer-links">
    <a class="page-footer-link" href="javascript:history.back()">返回</a>
    
      <a class="page-footer-link" href="">
        下一篇：自定义 Vim 编辑器的注释颜色
      </a>
     
  </div>
</div>

  </div>
</div>
    <div class="foot">
  <div class="footer">
    <span class="copyright">©️2020 ymcai.xyz</span>
    <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
  </div>
</div>

<script type="text/javascript">
function wrapTables() {
  var nodes = document.body.querySelectorAll('table');
  for (var i = 0; i < nodes.length; i++) {
    var table = nodes[i];
    var wrapEl = document.createElement('div');
    wrapEl.className = 'table-wrap';
    table.parentNode.replaceChild(wrapEl, table);
    wrapEl.appendChild(table)
  }
};
wrapTables();
</script>
  </body>
</html>