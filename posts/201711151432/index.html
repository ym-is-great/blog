 
<html>
  <head>
    <title>Let's Encrypt：免费 SSL 证书申请与部署</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2235676_71rm12z746w.css">
    <link rel="stylesheet" href="/libs/prism/prism.default.css">
    <link rel="stylesheet" href="/css/index.css">
  <meta name="generator" content="Hexo 5.2.0"></head>
  <body ontouchstart="">
    <div class="head">
  <div class="header">
    <div class="title">
      <a href="/"></a>ymcai</a>
    </div>
    <div class="menu">
      <a href="/">
        <span class="menu-item">首页</span>
      </a>
      <a href="/categories">
        <span class="menu-item">分类</span>
      </a>
      <a href="/about">
        <span class="menu-item">关于</span>
      </a>
    </div>
  </div>
</div>
    <div class="body">
  <div class="container">
     

<div class="post-header">
  <h1 class="post-title">Let's Encrypt：免费 SSL 证书申请与部署</h1>
  <div class="post-meta">
    <span>2017-11-15</span>
    
      
      <a class="post-meta-category" href="/categories/categories/back-end">后端</a>
    
  </div>
</div>
<div class="post-body main-body">
  <p>为了启用网站的 HTTPS 功能，需要向证书颁发机构（CA）申请证书。<a target="_blank" rel="noopener" href="https://letsencrypt.org/">Let’s Encrypt</a> 是一家 CA，同时也是一个由公益组织运营的项目，致力于普及安全链接。其颁发的免费 SSL 证书有三个月的有效期（不限次数免费续期），目前已得到包括 Chrome、Firefox 在内的所有主流浏览器的信任。</p>
<a id="more"></a>

<img src="/img/posts/2017/11/lets_encrypt_logo.png" class="" width="360">

<p>Let’s Encrypt 基于 ACME 协议验证你对一个域名的控制权。以 GetSSL （Let’s Encrypt 的客户端程序）为例，假设你的域名为 <code>yourdomain.com</code>，GetSSL 将随机生成一个页面，然后由 CA 服务器访问这个页面，我们假设这个页面的链接为 <code>https://yourdomain.com/token</code> 。如果可以访问，CA 服务器就会颁发该域名的 SSL 证书。</p>
<h3 id="获取-GetSSL"><a href="#获取-GetSSL" class="headerlink" title="获取 GetSSL"></a>获取 GetSSL</h3><p>Let’s Encrypt 官网介绍了超过 50 种客户端程序，全部由第三方开发，都可以用于申请证书。而我选择的是上文提到的 GetSSL 。注：官方推荐 <a target="_blank" rel="noopener" href="https://certbot.eff.org/">Certbot</a>，我试用的时候发现出错的几率蛮高的，感兴趣的话可以自行尝试。 </p>
<p>获取 GetSSL ： </p>
<pre class="line-numbers language-none"><code class="language-none">cd ~
git clone https:&#x2F;&#x2F;github.com&#x2F;srvrco&#x2F;getssl.git
cd getssl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<h3 id="配置-GetSSL"><a href="#配置-GetSSL" class="headerlink" title="配置 GetSSL"></a>配置 GetSSL</h3><p>执行命令生成配置文件，注意把 <code>yourdomain.com</code> 替换成你的域名。</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;getssl -c yourdomain.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>执行后将生成 GetSSL 的全局配置文件 <code>~/.getssl/getssl.cfg</code> ，及当前域名的配置文件 <code>~/.getssl/yourdomain.com/getssl.cfg</code> 。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 日志
# 创建全局配置文件
creating main config file &#x2F;root&#x2F;.getssl&#x2F;getssl.cfg
# 创建域名配置文件
Making domain directory - &#x2F;root&#x2F;.getssl&#x2F;yourdomain.com
creating domain config file in &#x2F;root&#x2F;.getssl&#x2F;yourdomain.com&#x2F;getssl.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编辑全局配置文件。由于默认的 CA 服务器仅用于测试，颁发的证书是不受浏览器信任的，需要修改成颁发完整证书的服务器。<code>RELOAD_CMD</code> 用于在证书颁发后自动重载 Web 服务器，使证书生效，非必填项。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 证书服务器地址
CA&#x3D;&quot;https:&#x2F;&#x2F;acme-v01.api.letsencrypt.org&quot;

# 服务器重载命令
RELOAD_CMD&#x3D;&quot;service nginx reload&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>编辑当前域名的配置文件。<code>ACL(Acme Challenge Location)</code> 是用于产生随机校验文件的路径，将 <code>/path/to/your/website/folder/</code> 改成你的网站根目录的绝对路径。接着配置文件的保存路径。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 校验路径
ACL&#x3D;(&#39;&#x2F;path&#x2F;to&#x2F;your&#x2F;website&#x2F;folder&#x2F;.well-known&#x2F;acme-challenge&#39;)

# 保存路径
DOMAIN_PEM_LOCATION&#x3D;&quot;&#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.pem&quot; # 证书文件路径
DOMAIN_KEY_LOCATION&#x3D;&quot;&#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.key&quot; # 私钥文件路径<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Tips: <code>DOMAIN_CERT_LOCATION</code> 和  <code>DOMAIN_PEM_LOCATION</code> 都可以配置证书文件路径，后者保存的证书包含证书链。如果不慎删除，可以在 <code>~/.getssl/yourdomain.com/archive</code> 找到每次签发的文件存档。</p>
<h3 id="配置-Nginx"><a href="#配置-Nginx" class="headerlink" title="配置 Nginx"></a>配置 Nginx</h3><p>配置你的 Web 引擎。这是在 Nginx 上启用并强制使用 HTTPS 访问的配置参考，<code>ssl_certificate</code> 和 <code>ssl_certificate_key</code> 指向上面配置的文件保存路径。</p>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
  listen 80;
  listen 443 ssl http2;
  ssl_certificate &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.pem;
  ssl_certificate_key &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.key;
  ssl_session_timeout 5m;
  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  if ($ssl_protocol &#x3D; &quot;&quot;) &#123; return 301 https:&#x2F;&#x2F;$host$request_uri; &#125;
  ...
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h3><p>执行命令申请 SSL 证书。</p>
<pre class="line-numbers language-none"><code class="language-none">cd ~&#x2F;getssl
.&#x2F;getssl yourdomain.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>若所有配置正确，网站的 HTTPS 应该已经生效。别忘了在你的 Web 服务器（Apache、Nginx 或 Lighttpd）上启用 SSL ，并指向刚刚申请的证书路径。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 日志
# 创建随机校验文件
copying challenge token to &#x2F;path&#x2F;to&#x2F;your&#x2F;website&#x2F;folder&#x2F;.well-known&#x2F;acme-challenge&#x2F;2ALrFFPercPe1i9-jA-_DBEJqlrPevCIf0Fzdk3HjWI
Pending
# 验证是否可以访问
Verified yourdomain.com
# 获取并保存证书
Verification completed, obtaining certificate.
Certificate saved in &#x2F;root&#x2F;.getssl&#x2F;yourdomain.com&#x2F;yourdomain.com.crt
The intermediate CA cert is in &#x2F;root&#x2F;.getssl&#x2F;yourdomain.com&#x2F;chain.crt
copying domain certificate to &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.crt
copying private key to &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.key
copying CA certificate to &#x2F;etc&#x2F;ssl&#x2F;chain.crt
# 重启 Web 服务器
reloading SSL services
Reloading nginx configuration (via systemctl):             [  OK  ]
yourdomain.com - certificate installed OK on server
certificate obtained for yourdomain.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Tips: 如遇到 <code>getssl: this script requires one of: nslookup drill dig host</code> 错误，尝试安装依赖包。</p>
<pre class="line-numbers language-none"><code class="language-none">yum install bind-utils
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="撤销证书"><a href="#撤销证书" class="headerlink" title="撤销证书"></a>撤销证书</h3><p>执行 <code>getssl -r path/to/cert path/to/key [CA_server]</code> 命令可以申请撤销已颁发的证书。需要指定证书和私钥文件的路径。<code>CA_server</code> 用于指定 CA 服务器，一般不需要填写。</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;getssl -r &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.crt &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="自动续期"><a href="#自动续期" class="headerlink" title="自动续期"></a>自动续期</h3><p>执行 <code>crontab -e</code> 编辑任务调度文件。添加一个任务。这样，GetSSL 将在每天凌晨检查一次，自动续期或更新证书版本。注意，不要删除 GetSSL 脚本文件。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">23 5 * * * &#x2F;root&#x2F;getssl -u -a -q<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>相关环境：Aliyun ECS / CentOS 7 x64 / Nginx 1.12</p>

  
    <div class="post-tags">
    
      
      <a class="post-tag" href="/tags/Nginx">Nginx</a>
    
      
      <a class="post-tag" href="/tags/SSL">SSL</a>
    
      
      <a class="post-tag" href="/tags/HTTPS">HTTPS</a>
    
      
      <a class="post-tag" href="/tags/Let's-Encrypt">Let's Encrypt</a>
    
      
      <a class="post-tag" href="/tags/ACME">ACME</a>
    
  </div>
  
</div>
<div class="page-footer">
  <div class="page-footer-links">
    <a class="page-footer-link" href="javascript:history.back()">返回</a>
    
      <a class="page-footer-link" href="">
        下一篇：JavaScript / Vue.js 实现时分秒倒计时
      </a>
     
  </div>
</div>

  </div>
</div>
    <div class="foot">
  <div class="footer">
    <span class="copyright">©️2020 ymcai.xyz</span>
    <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
  </div>
</div>

<script type="text/javascript">
function wrapTables() {
  var nodes = document.body.querySelectorAll('table');
  for (var i = 0; i < nodes.length; i++) {
    var table = nodes[i];
    var wrapEl = document.createElement('div');
    wrapEl.className = 'table-wrap';
    table.parentNode.replaceChild(wrapEl, table);
    wrapEl.appendChild(table)
  }
};
wrapTables();
</script>
  </body>
</html>