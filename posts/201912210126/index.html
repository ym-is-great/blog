 
<html>
  <head>
    <title>Chrome 扩展从入门到 HelloWorld</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2235676_71rm12z746w.css">
    <link rel="stylesheet" href="/libs/prism/prism.default.css">
    <link rel="stylesheet" href="/css/index.css">
  <meta name="generator" content="Hexo 5.2.0"></head>
  <body ontouchstart="">
    <div class="head">
  <div class="header">
    <div class="title">
      <a href="/"></a>ymcai</a>
    </div>
    <div class="menu">
      <a href="/">
        <span class="menu-item">首页</span>
      </a>
      <a href="/categories">
        <span class="menu-item">分类</span>
      </a>
      <a href="/about">
        <span class="menu-item">关于</span>
      </a>
    </div>
  </div>
</div>
    <div class="body">
  <div class="container">
     

<div class="post-header">
  <h1 class="post-title">Chrome 扩展从入门到 HelloWorld</h1>
  <div class="post-meta">
    <span>2019-12-21</span>
    
      
      <a class="post-meta-category" href="/categories/categories/web-front-end">Web 前端</a>
    
  </div>
</div>
<div class="post-body main-body">
  <h2 id="认识-Chrome-扩展"><a href="#认识-Chrome-扩展" class="headerlink" title="认识 Chrome 扩展"></a>认识 Chrome 扩展</h2><p>扩展（Extension）是用于修改或者增加浏览器功能的小型软件。“扩展”这个称谓可能稍显陌生，在国内人们更习惯于称它们为<strong>浏览器插件</strong>。它们使用 HTML，JavaScript, CSS 等网页开发技术构建。</p>
<a id="more"></a>

<p><strong>你可以理解为，扩展就是在浏览器中持续运行的网页，当你需要时随时唤醒它，而不需要等待加载。</strong>扩展之于 Chrome 浏览器，就像小程序之于微信。</p>
<img src="/img/posts/2019/12/chrome_extension_adblock.png" class="no-border" width="450" title="Chrome 扩展">

<p>Chrome 扩展经历了：</p>
<ul>
<li>2009年9月，谷歌开发者网站公布扩展。</li>
<li>2009年12月，Google Chrome 扩展程序中心公测，发布大约300个扩展。</li>
<li>2010年1月，Google Chrome 扩展程序中心正式上线，包含大约1500个扩展。</li>
<li>2010年12月，“扩展中心”升级为我们今天熟知的 Chrome 网上应用店。</li>
</ul>
<p><strong>时至今日，Chrome 网上应用店托管着大约19万个扩展。</strong></p>
<p>它们之中有大名鼎鼎的广告拦截程序 Adblock Plus，网页长截屏工具 Full Page Screen Capture，也有前端开发同学们熟悉的调试工具 Vue Devtools，React Developer Tools。</p>
<p>为什么扩展能够提供如此多样的功能？</p>
<p>除了程序猿们的努力，更重要的一点是 <strong>Chrome 开放了各种强大的接口</strong>赋能开发者。翻看文档可以发现，<code>chrome.tabs</code> 接口提供了“读取和修改页面内容”的能力，使得“屏蔽广告”成为可能。</p>
<p>这并不意味着扩展可以不受限制地访问你浏览的内容。和手机上的 app 类似，扩展需要获取权限才能使用相应的能力，同时受用户和 Chrome 网上应用店监督。</p>
<h2 id="Crome-扩展的结构"><a href="#Crome-扩展的结构" class="headerlink" title="Crome 扩展的结构"></a>Crome 扩展的结构</h2><p>扩展程序由一些“组件”构成。它们都由常见的 web 技术编写，各自负责不同的工作。</p>
<img src="/img/posts/2019/12/chrome_extension_structure.png" class="no-border" width="580" title="Chrome 扩展结构">

<p><strong>清单</strong></p>
<p>每个扩展都必须有一个 JSON 格式的清单文件（Manifest），作为扩展程序的配置文件，用于记录一些必不可少的信息。例如：名称和描述，需要使用哪些权限，可以如何与用户交互。</p>
<p>只要有这个文件，扩展就可以被浏览器识别和安装 —— 即使它不具备任何实用功能。</p>
<p><strong>背景页</strong></p>
<p>背景页（Background Page）是一个在后台持续运行的页面。</p>
<p>虽然称之为一个“页面”，但实际对用户是不可见的。背景页随着浏览器打开（扩展加载）而运行，直到浏览器关闭才会停止。它负责维护扩展的全局状态，还可以和其他扩展通信。</p>
<p><strong>弹窗</strong></p>
<p>弹窗（Popup）是扩展与用户交互最常用的方式。其实就是我们平常在浏览器的地址栏右侧，点击扩展按钮会显示的弹窗，通常提供一些设置选项。</p>
<p>弹窗的生命周期很短，切换标签页就会销毁，再次点击图标会打开一个新的弹窗实例。所以重要的临时数据和操作一定要放在背景页当中。</p>
<p><strong>内容脚本</strong></p>
<p>内容脚本（Content Scripts）是运行于网页的上下文环境中的脚本。它可以注入网页中，通过 DOM 读取和修改用户正在浏览的网页中的内容。</p>
<p>现在知道广告屏蔽插件如何让牛皮癣消失了吧？</p>
<p><strong>选项页</strong></p>
<p>选项页（Options Page）的本质是一个完整可见的网页，它的定位是向用户提供更多定制选项。</p>
<p>对于一些功能复杂的扩展，弹窗能够提供的交互是不够的。在工具栏右键点击扩展图标，选择菜单中的“选项”，即可浏览扩展的选项页。</p>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>接下来我们动手编写一个没什么卵用的 Chrome 扩展，它能够帮助你具备最基础的扩展开发能力。</p>
<h3 id="从清单开始"><a href="#从清单开始" class="headerlink" title="从清单开始"></a>从清单开始</h3><p>首先，新建一个目录并创建清单文件 <code>manifest.json</code>。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Chrome Extension Example"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Hello, Chrome extension!"</span><span class="token punctuation">,</span>
  <span class="token property">"manifest_version"</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://developer.chrome.com/extensions/manifest">完整</a> 的清单文件包含很多配置项，实际上必要的只有  <code>name</code>，<code>version</code> 和 <code>manifesct_version</code>。顾名思义分别是扩展的名称，版本，以及清单格式版本。</p>
<p>接着，通过工具栏菜单或访问 <code>chrome://extensions</code> 进入扩展程序管理。启用“开发者模式”。开启后即可通过本地目录安装扩展，调试背景页。</p>
<img src="/img/posts/2019/12/chrome_extension_management.png" class="no-border" width="480" title="扩展管理">

<p>点击“加载已解压的扩展程序”，选择刚才创建的目录，这个什么功能都没有的扩展就被安装到了浏览器上。地址栏的右侧也新增了一个按钮。</p>
<h3 id="添加背景页"><a href="#添加背景页" class="headerlink" title="添加背景页"></a>添加背景页</h3><p>接下来添加背景页，用来打印一段文字，顺便体验一下 Chrome 拓展 API。</p>
<p><code>chrome.storage</code> API 是扩展的存储接口。它提供了用于存储数据到云端（与用户的 Google 账户关联）的 <code>sync</code> 方法，以及存储数据到本地的 <code>local</code> 方法。</p>
<p>首先，在清单文件中注册 <code>storage</code> 权限和背景页。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token property">"permissions"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"storage"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"background"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"background.js"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"persistent"</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后，创建背景页脚本 <code>background.js</code>，它将在扩展安装后打印一段文字。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// background.js</span>
chrome<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>onInstalled<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 存储数据</span>
  chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> msg<span class="token operator">:</span> <span class="token string">'Hello, World!'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 读取数据</span>
    chrome<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'msg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 打印数据</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后，重新加载扩展并点击“查看背景页”，弹出的控制台中打印出了：“Hello, World!”。</p>
<img src="/img/posts/2019/12/chrome_extension_debug_background.png" class="no-border" width="540" title="调试背景页">

<h3 id="添加弹窗"><a href="#添加弹窗" class="headerlink" title="添加弹窗"></a>添加弹窗</h3><p>在清单文件中使用 <code>browser_action</code> 或 <code>page_action</code> 注册弹窗。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token property">"browser_action"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"default_popup"</span><span class="token operator">:</span> <span class="token string">"popup.html"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>两个配置项都可以自定义扩展按钮的图标和功能。它们的区别在于：浏览器按钮（Browser Action）默认在任何时候都可用；页面按钮（Page Action）按钮默认置灰，开发者按需为一些标签页或网址启用。用哪个取决于业务场景，这里我们用前者就行了。</p>
<p>接着，创建弹窗的布局文件 <code>popup.html</code>。仅仅设置了宽度，添加一串文本到 <code>&lt;body/&gt;</code> 中。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- popup.html --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"><span class="token selector">body</span> <span class="token punctuation">&#123;</span> <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>Hello, World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重新加载扩展并点击图标，图标下方出现自定义弹窗。</p>
<img src="/img/posts/2019/12/chrome_extension_popup.png" class="no-border" width="450" title="扩展的弹窗">

<h3 id="自定义图标"><a href="#自定义图标" class="headerlink" title="自定义图标"></a>自定义图标</h3><p>在按钮配置中使用 <code>default_icon</code> 设置图标。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token property">"browser_action"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"default_icon"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"16"</span><span class="token operator">:</span> <span class="token string">"images/icon_16.png"</span><span class="token punctuation">,</span>
      <span class="token property">"24"</span><span class="token operator">:</span> <span class="token string">"images/icon_24.png"</span><span class="token punctuation">,</span>
      <span class="token property">"32"</span><span class="token operator">:</span> <span class="token string">"images/icon_32.png"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"default_popup"</span><span class="token operator">:</span> <span class="token string">"popup.html"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>聪明的你应该注意到了，刚刚配置的图标和弹窗都是 <code>default</code> 开头的默认值。</p>
<p>这是因为 Chrome 提供了动态修改它们的接口。以浏览器按钮为例，<code>chrome.browserAction</code> API 包含了用于设置弹窗的 <code>setPopup</code>，以及用于设置图标的 <code>setIcon</code>。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>本想写一篇《Chrome 扩展：从入门到做一个 XXX 插件》，记录一个 <del>既有功能又有颜值</del> 还凑合的扩展开发全过程。由于工作太忙入完门就继续不下去了。文章在草稿里躺了半个月，今天正式宣布放弃。</p>
<p>但愿为感兴趣的同学上手浏览器扩展开发做了点微小工作。</p>
<p>Orz…</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>部分参考资料如下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Google_Chrome#Extensions">Google Chrome Extensions - Wikipedia</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.chrome.com/extensions">Extend the Browser - Google Chrome</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.chrome.com/extensions/api_index">Extension APIs - Google Chrome</a></li>
</ul>

  
    <div class="post-tags">
    
      
      <a class="post-tag" href="/tags/Chrome">Chrome</a>
    
      
      <a class="post-tag" href="/tags/WebComponents">WebComponents</a>
    
  </div>
  
</div>
<div class="page-footer">
  <div class="page-footer-links">
    <a class="page-footer-link" href="javascript:history.back()">返回</a>
    
      <a class="page-footer-link" href="">
        下一篇：Serverless 上车指南
      </a>
     
  </div>
</div>

  </div>
</div>
    <div class="foot">
  <div class="footer">
    <span class="copyright">©️2020 ymcai.xyz</span>
    <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
  </div>
</div>

<script type="text/javascript">
function wrapTables() {
  var nodes = document.body.querySelectorAll('table');
  for (var i = 0; i < nodes.length; i++) {
    var table = nodes[i];
    var wrapEl = document.createElement('div');
    wrapEl.className = 'table-wrap';
    table.parentNode.replaceChild(wrapEl, table);
    wrapEl.appendChild(table)
  }
};
wrapTables();
</script>
  </body>
</html>