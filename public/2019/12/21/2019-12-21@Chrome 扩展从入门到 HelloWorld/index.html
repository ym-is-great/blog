<html>
  <head>
    <title>ym</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/app.css">
  <meta name="generator" content="Hexo 4.2.1"></head>
  <body>
    <div class="head">
      <div class="header">
        <a href="/ ">
          <div class="site-title">YM</div>
        </a>
      </div>
    </div>
    <div class="body">
      <div class="content">
        Chrome 扩展从入门到 HelloWorld 
<h2 id="认识-Chrome-扩展"><a href="#认识-Chrome-扩展" class="headerlink" title="认识 Chrome 扩展"></a>认识 Chrome 扩展</h2><p>扩展（Extension）是用于修改或者增加浏览器功能的小型软件。“扩展”这个称谓可能稍显陌生，在国内人们更习惯于称它们为<strong>浏览器插件</strong>。它们使用 HTML，JavaScript, CSS 等网页开发技术构建。</p>
<a id="more"></a>

<p><strong>你可以理解为，扩展就是在浏览器中持续运行的网页，当你需要时随时唤醒它，而不需要等待加载。</strong>扩展之于 Chrome 浏览器，就像小程序之于微信。</p>
<img src="/images/posts/2019/12/chrome_extension_adblock.png" class="no-border" width="450" title="Chrome 扩展">

<p>Chrome 扩展经历了：</p>
<ul>
<li>2009年9月，谷歌开发者网站公布扩展。</li>
<li>2009年12月，Google Chrome 扩展程序中心公测，发布大约300个扩展。</li>
<li>2010年1月，Google Chrome 扩展程序中心正式上线，包含大约1500个扩展。</li>
<li>2010年12月，“扩展中心”升级为我们今天熟知的 Chrome 网上应用店。</li>
</ul>
<p><strong>时至今日，Chrome 网上应用店托管着大约19万个扩展。</strong></p>
<p>它们之中有大名鼎鼎的广告拦截程序 Adblock Plus，网页长截屏工具 Full Page Screen Capture，也有前端开发同学们熟悉的调试工具 Vue Devtools，React Developer Tools。</p>
<p>为什么扩展能够提供如此多样的功能？</p>
<p>除了程序猿们的努力，更重要的一点是 <strong>Chrome 开放了各种强大的接口</strong>赋能开发者。翻看文档可以发现，<code>chrome.tabs</code> 接口提供了“读取和修改页面内容”的能力，使得“屏蔽广告”成为可能。</p>
<p>这并不意味着扩展可以不受限制地访问你浏览的内容。和手机上的 app 类似，扩展需要获取权限才能使用相应的能力，同时受用户和 Chrome 网上应用店监督。</p>
<h2 id="Crome-扩展的结构"><a href="#Crome-扩展的结构" class="headerlink" title="Crome 扩展的结构"></a>Crome 扩展的结构</h2><p>扩展程序由一些“组件”构成。它们都由常见的 web 技术编写，各自负责不同的工作。</p>
<img src="/images/posts/2019/12/chrome_extension_structure.png" class="no-border" width="580" title="Chrome 扩展结构">

<p><strong>清单</strong></p>
<p>每个扩展都必须有一个 JSON 格式的清单文件（Manifest），作为扩展程序的配置文件，用于记录一些必不可少的信息。例如：名称和描述，需要使用哪些权限，可以如何与用户交互。</p>
<p>只要有这个文件，扩展就可以被浏览器识别和安装 —— 即使它不具备任何实用功能。</p>
<p><strong>背景页</strong></p>
<p>背景页（Background Page）是一个在后台持续运行的页面。</p>
<p>虽然称之为一个“页面”，但实际对用户是不可见的。背景页随着浏览器打开（扩展加载）而运行，直到浏览器关闭才会停止。它负责维护扩展的全局状态，还可以和其他扩展通信。</p>
<p><strong>弹窗</strong></p>
<p>弹窗（Popup）是扩展与用户交互最常用的方式。其实就是我们平常在浏览器的地址栏右侧，点击扩展按钮会显示的弹窗，通常提供一些设置选项。</p>
<p>弹窗的生命周期很短，切换标签页就会销毁，再次点击图标会打开一个新的弹窗实例。所以重要的临时数据和操作一定要放在背景页当中。</p>
<p><strong>内容脚本</strong></p>
<p>内容脚本（Content Scripts）是运行于网页的上下文环境中的脚本。它可以注入网页中，通过 DOM 读取和修改用户正在浏览的网页中的内容。</p>
<p>现在知道广告屏蔽插件如何让牛皮癣消失了吧？</p>
<p><strong>选项页</strong></p>
<p>选项页（Options Page）的本质是一个完整可见的网页，它的定位是向用户提供更多定制选项。</p>
<p>对于一些功能复杂的扩展，弹窗能够提供的交互是不够的。在工具栏右键点击扩展图标，选择菜单中的“选项”，即可浏览扩展的选项页。</p>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>接下来我们动手编写一个没什么卵用的 Chrome 扩展，它能够帮助你具备最基础的扩展开发能力。</p>
<h3 id="从清单开始"><a href="#从清单开始" class="headerlink" title="从清单开始"></a>从清单开始</h3><p>首先，新建一个目录并创建清单文件 <code>manifest.json</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Chrome Extension Example"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"Hello, Chrome extension!"</span>,</span><br><span class="line">  <span class="attr">"manifest_version"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://developer.chrome.com/extensions/manifest" target="_blank" rel="noopener">完整</a> 的清单文件包含很多配置项，实际上必要的只有  <code>name</code>，<code>version</code> 和 <code>manifesct_version</code>。顾名思义分别是扩展的名称，版本，以及清单格式版本。</p>
<p>接着，通过工具栏菜单或访问 <code>chrome://extensions</code> 进入扩展程序管理。启用“开发者模式”。开启后即可通过本地目录安装扩展，调试背景页。</p>
<img src="/images/posts/2019/12/chrome_extension_management.png" class="no-border" width="480" title="扩展管理">

<p>点击“加载已解压的扩展程序”，选择刚才创建的目录，这个什么功能都没有的扩展就被安装到了浏览器上。地址栏的右侧也新增了一个按钮。</p>
<h3 id="添加背景页"><a href="#添加背景页" class="headerlink" title="添加背景页"></a>添加背景页</h3><p>接下来添加背景页，用来打印一段文字，顺便体验一下 Chrome 拓展 API。</p>
<p><code>chrome.storage</code> API 是扩展的存储接口。它提供了用于存储数据到云端（与用户的 Google 账户关联）的 <code>sync</code> 方法，以及存储数据到本地的 <code>local</code> 方法。</p>
<p>首先，在清单文件中注册 <code>storage</code> 权限和背景页。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">"permissions"</span>: [<span class="string">"storage"</span>],</span><br><span class="line">  <span class="attr">"background"</span>: &#123;</span><br><span class="line">    <span class="attr">"scripts"</span>: [<span class="string">"background.js"</span>],</span><br><span class="line">    <span class="attr">"persistent"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，创建背景页脚本 <code>background.js</code>，它将在扩展安装后打印一段文字。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// background.js</span></span><br><span class="line">chrome.runtime.onInstalled.addListener(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 存储数据</span></span><br><span class="line">  chrome.storage.sync.set(&#123; <span class="attr">msg</span>: <span class="string">'Hello, World!'</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 读取数据</span></span><br><span class="line">    chrome.storage.sync.get([<span class="string">'msg'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 打印数据</span></span><br><span class="line">      <span class="built_in">console</span>.log(result.msg)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>最后，重新加载扩展并点击“查看背景页”，弹出的控制台中打印出了：“Hello, World!”。</p>
<img src="/images/posts/2019/12/chrome_extension_debug_background.png" class="no-border" width="540" title="调试背景页">

<h3 id="添加弹窗"><a href="#添加弹窗" class="headerlink" title="添加弹窗"></a>添加弹窗</h3><p>在清单文件中使用 <code>browser_action</code> 或 <code>page_action</code> 注册弹窗。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">"browser_action"</span>: &#123;</span><br><span class="line">    <span class="attr">"default_popup"</span>: <span class="string">"popup.html"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个配置项都可以自定义扩展按钮的图标和功能。它们的区别在于：浏览器按钮（Browser Action）默认在任何时候都可用；页面按钮（Page Action）按钮默认置灰，开发者按需为一些标签页或网址启用。用哪个取决于业务场景，这里我们用前者就行了。</p>
<p>接着，创建弹窗的布局文件 <code>popup.html</code>。仅仅设置了宽度，添加一串文本到 <code>&lt;body/&gt;</code> 中。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- popup.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"><span class="selector-tag">body</span> &#123; <span class="attribute">width</span>: <span class="number">100px</span>; &#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span>Hello, World!<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>重新加载扩展并点击图标，图标下方出现自定义弹窗。</p>
<img src="/images/posts/2019/12/chrome_extension_popup.png" class="no-border" width="450" title="扩展的弹窗">

<h3 id="自定义图标"><a href="#自定义图标" class="headerlink" title="自定义图标"></a>自定义图标</h3><p>在按钮配置中使用 <code>default_icon</code> 设置图标。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">"browser_action"</span>: &#123;</span><br><span class="line">    <span class="attr">"default_icon"</span>: &#123;</span><br><span class="line">      <span class="attr">"16"</span>: <span class="string">"images/icon_16.png"</span>,</span><br><span class="line">      <span class="attr">"24"</span>: <span class="string">"images/icon_24.png"</span>,</span><br><span class="line">      <span class="attr">"32"</span>: <span class="string">"images/icon_32.png"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"default_popup"</span>: <span class="string">"popup.html"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>聪明的你应该注意到了，刚刚配置的图标和弹窗都是 <code>default</code> 开头的默认值。</p>
<p>这是因为 Chrome 提供了动态修改它们的接口。以浏览器按钮为例，<code>chrome.browserAction</code> API 包含了用于设置弹窗的 <code>setPopup</code>，以及用于设置图标的 <code>setIcon</code>。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>本想写一篇《Chrome 扩展：从入门到做一个 XXX 插件》，记录一个 <del>既有功能又有颜值</del> 还凑合的扩展开发全过程。由于工作太忙入完门就继续不下去了。文章在草稿里躺了半个月，今天正式宣布放弃。</p>
<p>但愿为感兴趣的同学上手浏览器扩展开发做了点微小工作。</p>
<p>Orz…</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>部分参考资料如下：</p>
<ul>
<li><p><a href="https://en.wikipedia.org/wiki/Google_Chrome#Extensions" target="_blank" rel="noopener">Google Chrome Extensions - Wikipedia</a></p>
</li>
<li><p><a href="https://developer.chrome.com/extensions" target="_blank" rel="noopener">Extend the Browser - Google Chrome</a></p>
</li>
<li><p><a href="https://developer.chrome.com/extensions/api_index" target="_blank" rel="noopener">Extension APIs - Google Chrome</a></p>
</li>
</ul>
 
      </div>
    </div>
    <div class="foot">
      <div class="footer">
        <span class="copyright">©️2020 ym</span>
        <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
      </div>
    </div>
  </body>
</html>