<html>
  <head>
    <title>ym</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/app.css">
  <meta name="generator" content="Hexo 4.2.1"></head>
  <body>
    <div class="head">
      <div class="header">
        <a href="/ ">
          <div class="site-title">YM</div>
        </a>
      </div>
    </div>
    <div class="body">
      <div class="content">
        混合开发：Android 与 JavaScript 的相互通信 
<p>现代移动应用开发已经广泛运用了 Hybrid 模式，催生了 Hybrid App（混合模式移动应用），即在原生壳中内嵌网页，部分功能由 HTML5 实现的移动应用。</p>
<p>这种方案能大幅减少开发时间和成本，易于更新维护。因此以淘宝、京东为代表的电商 app，经常使用网页实现需灵活更新的页面。</p>
<a id="more"></a>

<p>Hybrid 的基础是原生与网页的相互通信。在 Android 平台可以认为是 Java 和 JavaScript 的相互调用。</p>
<h2 id="Android-调用-JavaScript"><a href="#Android-调用-JavaScript" class="headerlink" title="Android 调用 JavaScript"></a>Android 调用 JavaScript</h2><h3 id="loadUrl"><a href="#loadUrl" class="headerlink" title="loadUrl"></a>loadUrl</h3><p>在 Android 中调用 JavaScript 最简单的方式是使用 <code>WebView.loadUrl</code> 方法。</p>
<p><code>loadUrl</code> 用于加载给定的链接。在链接中使用 <code>javascript</code> 伪协议，浏览器将执行 <code>:</code> 后面的 JavaScript 代码。</p>
<p>下面这行代码执行了 JS 中的 <code>showMessage</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWebView.loadUrl(<span class="string">"javascript:showMessage('Hello, Web!')"</span>);</span><br></pre></td></tr></table></figure>

<p>这种方式的缺点是无法取得返回值，适合不需要返回值的场景。</p>
<h3 id="evaluateJavascript"><a href="#evaluateJavascript" class="headerlink" title="evaluateJavascript"></a>evaluateJavascript</h3><p>Android 4.4 以后提供了 <code>WebView.evaluateJavascript</code> 方法。它用于异步执行 JavaScript，当返回值非空时执行回调，据说有着比 <code>loadUrl</code> 更高的执行效率。</p>
<p>下面这段代码同样执行了 JS 中的 <code>showMessage</code> 函数，并且能够在 <code>onReceiveValue</code> 方法中拿到返回值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mWebView.evaluateJavascript(<span class="string">"javascript:showMessage('Hello, Web!')"</span>, <span class="keyword">new</span> ValueCallback&lt;String&gt;() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceiveValue</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 打印返回值</span></span><br><span class="line">    log.d(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="JavaScript-调用-Android"><a href="#JavaScript-调用-Android" class="headerlink" title="JavaScript 调用 Android"></a>JavaScript 调用 Android</h2><h3 id="shouldOverrideUrlLoading"><a href="#shouldOverrideUrlLoading" class="headerlink" title="shouldOverrideUrlLoading"></a>shouldOverrideUrlLoading</h3><p><code>WebViewClient.shouldOverrideUrlLoading</code> 用于拦截即将加载的链接，重写默认行为。</p>
<p>因此，我们可以事先约定一系列伪协议链接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myapp:&#x2F;&#x2F;showToast?text&#x3D;Hello</span><br></pre></td></tr></table></figure>

<p>然后在 Android 中拦截 WebView 加载的链接。对于符合约定格式的链接，执行相应的操作。对于其他链接，保持默认的加载行为。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_SCHEME = <span class="string">"myapp:"</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">mWebView.setWebViewClient(<span class="keyword">new</span> WebViewClient() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (url.startsWith(APP_SCHEME)) &#123;</span><br><span class="line">            <span class="comment">// 解析链接</span></span><br><span class="line">            urlData = URLDecoder.decode(url.substring(APP_SCHEME.length()), <span class="string">"UTF-8"</span>);</span><br><span class="line">            <span class="comment">// 执行相应操作...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在网页中调用时只需要当作一个重定向就够了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.location.href = <span class="string">'myapp://showToast?text=Hello'</span></span><br></pre></td></tr></table></figure>

<h3 id="addJavascriptInterface"><a href="#addJavascriptInterface" class="headerlink" title="addJavascriptInterface"></a>addJavascriptInterface</h3><p><code>WebView.addJavascriptInterface</code> 用于绑定接口，使 JavaScript 能够调用 Android 代码。</p>
<p>简单地说，我们在 Android 里声明接口。接口包含我们想要暴露给网页调用的方法，它以对象的形式注入到 JavaScript 的 <code>Window</code> 对象下。最后，JavaScript 调用接口对象的方法，执行接口中的原生代码。</p>
<p>首先创建一个接口类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebAppInterface</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  Context mContext;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化接口并设置上下文</span></span><br><span class="line">  WebAppInterface(Context c) &#123;</span><br><span class="line">    mContext = c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 显示短消息的接口</span></span><br><span class="line">  <span class="meta">@JavascriptInterface</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">    Toast.makeText(mContext, text, Toast.LENGTH_SHORT).show();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，Android 4.2 以上使用 <code>@JavascriptInterface</code> 注解的方法才会暴露给 JavaScript。</p>
<p>然后向 WebView 添加这个接口，并将其命名为 <code>Android</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> WebAppInterface(<span class="keyword">this</span>), <span class="string">"Android"</span>);</span><br></pre></td></tr></table></figure>

<p>当网页加载完成时，WebView 也将注入一个 <code>Window.Android</code> 对象。</p>
<p>通过这个对象就可以调用接口中的原生方法了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Android.showToast(<span class="string">'Hello, Android!'</span>)</span><br></pre></td></tr></table></figure>



<h2 id="使用-JsBridge"><a href="#使用-JsBridge" class="headerlink" title="使用 JsBridge"></a>使用 JsBridge</h2><p>JsBridge 是一个成熟的，用于原生和网页双向通信的开源库。它封装了上文提到的通信方式，并且提供包含传参、返回值和回调的完整方案。JsBridge 会向网页注入一个 <code>Window.WebViewJavascriptBridge</code>  对象。</p>
<p>JsBridge 的使用方法非常简单。</p>
<p>在布局文件中使用 <code>com.github.lzyzsd.jsbridge.BridgeWebView</code> 替代默认的 <code>WebView</code> 控件。</p>
<p>接着注册一个 Java 处理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">webView.registerHandler(<span class="string">"showToast"</span>, <span class="keyword">new</span> BridgeHandler() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(String data, CallBackFunction function)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 执行原生代码...</span></span><br><span class="line">    function.onCallBack(<span class="string">"return value"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在 JavaScript 中调用 Java 处理器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WebViewJavascriptBridge.callHandler(<span class="string">'showToast'</span>, <span class="string">'Hello, Android!'</span>, responseData =&gt; &#123;</span><br><span class="line">  <span class="comment">// 打印返回值</span></span><br><span class="line">  <span class="built_in">console</span>.log(responseData)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>类似的，我们也可以注册 JavaScript 处理器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WebViewJavascriptBridge.registerHandler(<span class="string">'showMessage'</span>, (data, responseCallback) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行网页脚本...</span></span><br><span class="line">  responseCallback(<span class="string">'return value'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然后在 Java 中调用 JavaScript 处理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">webView.callHandler(<span class="string">"showMessage"</span>, <span class="string">"Hello, JavaScript!"</span>, <span class="keyword">new</span> CallBackFunction() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCallBack</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 打印返回值</span></span><br><span class="line">    log.d(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>访问 <a href="https://github.com/lzyzsd/JsBridge" target="_blank" rel="noopener">GitHub</a> 了解更多 JsBridge 的使用说明。</p>
<p>相关环境：macOS 10.14 / Android Studio 3.3 / JsBridge 1.0</p>
 
      </div>
    </div>
    <div class="foot">
      <div class="footer">
        <span class="copyright">©️2020 ym</span>
        <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
      </div>
    </div>
  </body>
</html>