<html>
  <head>
    <title>ym</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/app.css">
  <meta name="generator" content="Hexo 4.2.1"></head>
  <body>
    <div class="head">
      <div class="header">
        <a href="/ ">
          <div class="site-title">YM</div>
        </a>
      </div>
    </div>
    <div class="body">
      <div class="content">
        Let's Encrypt：免费 SSL 证书申请与部署 
<p>为了启用网站的 HTTPS 功能，需要向证书颁发机构（CA）申请证书。<a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a> 是一家 CA，同时也是一个由公益组织运营的项目，致力于普及安全链接。其颁发的免费 SSL 证书有三个月的有效期（不限次数免费续期），目前已得到包括 Chrome、Firefox 在内的所有主流浏览器的信任。</p>
<a id="more"></a>

<img src="/images/posts/2017/11/lets_encrypt_logo.png" class="" width="360">

<p>Let’s Encrypt 基于 ACME 协议验证你对一个域名的控制权。以 GetSSL （Let’s Encrypt 的客户端程序）为例，假设你的域名为 <code>yourdomain.com</code>，GetSSL 将随机生成一个页面，然后由 CA 服务器访问这个页面，我们假设这个页面的链接为 <code>https://yourdomain.com/token</code> 。如果可以访问，CA 服务器就会颁发该域名的 SSL 证书。</p>
<h3 id="获取-GetSSL"><a href="#获取-GetSSL" class="headerlink" title="获取 GetSSL"></a>获取 GetSSL</h3><p>Let’s Encrypt 官网介绍了超过 50 种客户端程序，全部由第三方开发，都可以用于申请证书。而我选择的是上文提到的 GetSSL 。注：官方推荐 <a href="https://certbot.eff.org/" target="_blank" rel="noopener">Certbot</a>，我试用的时候发现出错的几率蛮高的，感兴趣的话可以自行尝试。 </p>
<p>获取 GetSSL ： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;srvrco&#x2F;getssl.git</span><br><span class="line">cd getssl</span><br></pre></td></tr></table></figure>


<h3 id="配置-GetSSL"><a href="#配置-GetSSL" class="headerlink" title="配置 GetSSL"></a>配置 GetSSL</h3><p>执行命令生成配置文件，注意把 <code>yourdomain.com</code> 替换成你的域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;getssl -c yourdomain.com</span><br></pre></td></tr></table></figure>

<p>执行后将生成 GetSSL 的全局配置文件 <code>~/.getssl/getssl.cfg</code> ，及当前域名的配置文件 <code>~/.getssl/yourdomain.com/getssl.cfg</code> 。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志</span></span><br><span class="line"><span class="comment"># 创建全局配置文件</span></span><br><span class="line">creating main config file /root/.getssl/getssl.cfg</span><br><span class="line"><span class="comment"># 创建域名配置文件</span></span><br><span class="line">Making domain directory - /root/.getssl/yourdomain.com</span><br><span class="line">creating domain config file <span class="keyword">in</span> /root/.getssl/yourdomain.com/getssl.cfg</span><br></pre></td></tr></table></figure>

<p>编辑全局配置文件。由于默认的 CA 服务器仅用于测试，颁发的证书是不受浏览器信任的，需要修改成颁发完整证书的服务器。<code>RELOAD_CMD</code> 用于在证书颁发后自动重载 Web 服务器，使证书生效，非必填项。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 证书服务器地址</span></span><br><span class="line">CA=<span class="string">"https://acme-v01.api.letsencrypt.org"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务器重载命令</span></span><br><span class="line">RELOAD_CMD=<span class="string">"service nginx reload"</span></span><br></pre></td></tr></table></figure>


<p>编辑当前域名的配置文件。<code>ACL(Acme Challenge Location)</code> 是用于产生随机校验文件的路径，将 <code>/path/to/your/website/folder/</code> 改成你的网站根目录的绝对路径。接着配置文件的保存路径。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 校验路径</span></span><br><span class="line">ACL=(<span class="string">'/path/to/your/website/folder/.well-known/acme-challenge'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存路径</span></span><br><span class="line">DOMAIN_PEM_LOCATION=<span class="string">"/etc/ssl/yourdomain.com.pem"</span> <span class="comment"># 证书文件路径</span></span><br><span class="line">DOMAIN_KEY_LOCATION=<span class="string">"/etc/ssl/yourdomain.com.key"</span> <span class="comment"># 私钥文件路径</span></span><br></pre></td></tr></table></figure>

<p>Tips: <code>DOMAIN_CERT_LOCATION</code> 和  <code>DOMAIN_PEM_LOCATION</code> 都可以配置证书文件路径，后者保存的证书包含证书链。如果不慎删除，可以在 <code>~/.getssl/yourdomain.com/archive</code> 找到每次签发的文件存档。</p>
<h3 id="配置-Nginx"><a href="#配置-Nginx" class="headerlink" title="配置 Nginx"></a>配置 Nginx</h3><p>配置你的 Web 引擎。这是在 Nginx 上启用并强制使用 HTTPS 访问的配置参考，<code>ssl_certificate</code> 和 <code>ssl_certificate_key</code> 指向上面配置的文件保存路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  ssl_certificate &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.pem;</span><br><span class="line">  ssl_certificate_key &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.key;</span><br><span class="line">  ssl_session_timeout 5m;</span><br><span class="line">  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">  ssl_prefer_server_ciphers on;</span><br><span class="line">  if ($ssl_protocol &#x3D; &quot;&quot;) &#123; return 301 https:&#x2F;&#x2F;$host$request_uri; &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h3><p>执行命令申请 SSL 证书。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;getssl</span><br><span class="line">.&#x2F;getssl yourdomain.com</span><br></pre></td></tr></table></figure>


<p>若所有配置正确，网站的 HTTPS 应该已经生效。别忘了在你的 Web 服务器（Apache、Nginx 或 Lighttpd）上启用 SSL ，并指向刚刚申请的证书路径。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志</span></span><br><span class="line"><span class="comment"># 创建随机校验文件</span></span><br><span class="line">copying challenge token to /path/to/your/website/folder/.well-known/acme-challenge/2ALrFFPercPe1i9-jA-_DBEJqlrPevCIf0Fzdk3HjWI</span><br><span class="line">Pending</span><br><span class="line"><span class="comment"># 验证是否可以访问</span></span><br><span class="line">Verified yourdomain.com</span><br><span class="line"><span class="comment"># 获取并保存证书</span></span><br><span class="line">Verification completed, obtaining certificate.</span><br><span class="line">Certificate saved <span class="keyword">in</span> /root/.getssl/yourdomain.com/yourdomain.com.crt</span><br><span class="line">The intermediate CA cert is <span class="keyword">in</span> /root/.getssl/yourdomain.com/chain.crt</span><br><span class="line">copying domain certificate to /etc/ssl/yourdomain.com.crt</span><br><span class="line">copying private key to /etc/ssl/yourdomain.com.key</span><br><span class="line">copying CA certificate to /etc/ssl/chain.crt</span><br><span class="line"><span class="comment"># 重启 Web 服务器</span></span><br><span class="line">reloading SSL services</span><br><span class="line">Reloading nginx configuration (via systemctl):             [  OK  ]</span><br><span class="line">yourdomain.com - certificate installed OK on server</span><br><span class="line">certificate obtained <span class="keyword">for</span> yourdomain.com</span><br></pre></td></tr></table></figure>

<p>Tips: 如遇到 <code>getssl: this script requires one of: nslookup drill dig host</code> 错误，尝试安装依赖包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install bind-utils</span><br></pre></td></tr></table></figure>

<h3 id="撤销证书"><a href="#撤销证书" class="headerlink" title="撤销证书"></a>撤销证书</h3><p>执行 <code>getssl -r path/to/cert path/to/key [CA_server]</code> 命令可以申请撤销已颁发的证书。需要指定证书和私钥文件的路径。<code>CA_server</code> 用于指定 CA 服务器，一般不需要填写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;getssl -r &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.crt &#x2F;etc&#x2F;ssl&#x2F;yourdomain.com.key</span><br></pre></td></tr></table></figure>

<h3 id="自动续期"><a href="#自动续期" class="headerlink" title="自动续期"></a>自动续期</h3><p>执行 <code>crontab -e</code> 编辑任务调度文件。添加一个任务。这样，GetSSL 将在每天凌晨检查一次，自动续期或更新证书版本。注意，不要删除 GetSSL 脚本文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">23 5 * * * /root/getssl -u -a -q</span><br></pre></td></tr></table></figure>


<p>相关环境：Aliyun ECS / CentOS 7 x64 / Nginx 1.12</p>
 
      </div>
    </div>
    <div class="foot">
      <div class="footer">
        <span class="copyright">©️2020 ym</span>
        <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
      </div>
    </div>
  </body>
</html>