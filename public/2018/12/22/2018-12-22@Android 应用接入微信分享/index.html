<html>
  <head>
    <title>ym</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/app.css">
  <meta name="generator" content="Hexo 4.2.1"></head>
  <body>
    <div class="head">
      <div class="header">
        <a href="/ ">
          <div class="site-title">YM</div>
        </a>
      </div>
    </div>
    <div class="body">
      <div class="content">
        Android 应用接入微信分享 
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="在微信开放平台注册"><a href="#在微信开放平台注册" class="headerlink" title="在微信开放平台注册"></a>在微信开放平台注册</h3><p>登陆 <a href="https://open.weixin.qq.com/" target="_blank" rel="noopener">微信开放平台</a> 创建一个移动应用，正确填写应用 <strong>名称</strong>，<strong>包名</strong> 和 <strong>签名</strong>，得到一个 <code>AppID</code> 。</p>
<a id="more"></a>

<ul>
<li><p>移动应用名称，将显示在用户分享的信息中。</p>
</li>
<li><p>应用包名，相信接触过 Android 的开发者都已经很熟悉了，它是项目中的基础软件包的名称。包名的格式是域名的反写，例如，微信客户端的包名是 <code>com.tencent.mm</code> 。</p>
</li>
<li><p>应用签名，是签名所用密钥的 MD5 指纹。Android 要求应用必须先使用证书进行签名，然后才能安装。所以你生成的，可供任意用户安装的应用，必然可以查询到一个密钥指纹。许多人在接入后无法调起分享，仅仅是因为获取指纹的姿势不对。为了少走弯路，建议直接通过微信提供的 <a href="https://res.wx.qq.com/open/zh_CN/htmledition/res/dev/download/sdk/Gen_Signature_Android.apk" target="_blank" rel="noopener">签名获取工具</a> 查询。</p>
</li>
</ul>
<h3 id="配置-debug-版本签名"><a href="#配置-debug-版本签名" class="headerlink" title="配置 debug 版本签名"></a>配置 debug 版本签名</h3><p>默认情况下，通过开发工具直接运行在模拟器上的应用是不包含签名的。这也是签名校验失败的可能原因之一。为了方便在开发时调用微信接口，需要配置 debug 版本签名。</p>
<ol>
<li>右击项目，选择 <code>Open Module Settings</code> ，打开项目结构配置。</li>
<li>在 <code>Signing</code> 选项卡下添加一个签名，填好密钥信息。</li>
<li>在 <code>Build Types</code> 选项卡下修改 debug 版本的 <code>Signing Config</code> ，选择第二步中添加的签名。</li>
</ol>
<img src="/images/posts/2018/12/android_project_structure.png" class="no-border" width="480" title="Android Project Structure">

<h2 id="接入微信-SDK"><a href="#接入微信-SDK" class="headerlink" title="接入微信 SDK"></a>接入微信 SDK</h2><p>接入 SDK 的过程非常简单。</p>
<p>第一步，在 Gradle 的配置文件中添加依赖，等待 SDK 下载完毕。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build.gradle (Module: app)</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">  implementation <span class="string">'com.tencent.mm.opensdk:wechat-sdk-android-without-mta:+'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二步，在清单文件中声明必要的权限。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- AndroidManifest.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_WIFI_STATE"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.READ_PHONE_STATE"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="注册到微信"><a href="#注册到微信" class="headerlink" title="注册到微信"></a>注册到微信</h2><p>在调用微信客户端的功能之前，需要先使用 <code>registerApp</code> 注册你申请到的 <code>AppID</code> 。这一步的目的是确认当前应用的包名、签名与微信开放平台上登记的一致。常量 <code>APP_ID</code> 的值应该是你的 <code>AppID</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">api = WXAPIFactory.createWXAPI(context, APP_ID, <span class="keyword">true</span>);</span><br><span class="line">api.registerApp(APP_ID);</span><br></pre></td></tr></table></figure>

<h2 id="分享内容到微信"><a href="#分享内容到微信" class="headerlink" title="分享内容到微信"></a>分享内容到微信</h2><p>要分享内容到微信，你的 APP 应该向微信客户端发送一个包含 <strong>微信媒体消息</strong>（WXMediaMessage）的发信请求。微信媒体消息通常包含基础的标题、描述、缩略图，和一个媒体对象。</p>
<p>分享的媒体可以是网页、文件、小程序等，微信 SDK 提供了 <a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&id=open1419317340" target="_blank" rel="noopener">丰富的对象</a> 以便发送不同类型的内容。</p>
<p>以分享一个网页到朋友圈为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置网址</span></span><br><span class="line">WXWebpageObject webpage = <span class="keyword">new</span> WXWebpageObject();</span><br><span class="line">webpage.webpageUrl = <span class="string">"https://example.blog"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置标题</span></span><br><span class="line">WXMediaMessage msg = <span class="keyword">new</span> WXMediaMessage(webpage);</span><br><span class="line">msg.title = <span class="string">"My Blog"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置缩略图</span></span><br><span class="line">Bitmap thumb = BitmapFactory.decodeResource(context.getResources(), R.mipmap.ic_thumb);</span><br><span class="line">msg.thumbData = Image.bitmapToByteArray(thumb);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造一个发信请求</span></span><br><span class="line">SendMessageToWX.Req req = <span class="keyword">new</span> SendMessageToWX.Req();</span><br><span class="line">req.transaction = String.valueOf(System.currentTimeMillis());</span><br><span class="line">req.message = msg;</span><br><span class="line">req.scene = WXSceneTimeline;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送请求给微信客户端</span></span><br><span class="line">api.sendReq(req);</span><br></pre></td></tr></table></figure>

<p>消息中的缩略图 <code>thumbData</code> 应该是字节数据。下面是一个将位图转换成字节数据的示例方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] bitmapToByteArray(Bitmap bitmap)&#123;</span><br><span class="line">  ByteArrayOutputStream output = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">  bitmap.compress(Bitmap.CompressFormat.JPEG, <span class="number">100</span>, output);</span><br><span class="line">  <span class="keyword">return</span> output.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个发信请求还应该包括场景和事务ID：</p>
<ul>
<li><p>分享场景 <code>scene</code> 可选对话 <code>WXSceneSession</code>、朋友圈 <code>WXSceneTimeline</code> 和收藏 <code>WXSceneFavorite</code> 三种。</p>
</li>
<li><p>事务ID  <code>transaction</code> 用于唯一标识一个请求。</p>
</li>
</ul>
<p>相关环境：macOS 10.14 / Android Studio 3.2 / WeChat SDK for Android 5.1</p>
 
      </div>
    </div>
    <div class="foot">
      <div class="footer">
        <span class="copyright">©️2020 ym</span>
        <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
      </div>
    </div>
  </body>
</html>