<html>
  <head>
    <title>ym</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/app.css">
  <meta name="generator" content="Hexo 4.2.1"></head>
  <body>
    <div class="head">
      <div class="header">
        <a href="/ ">
          <div class="site-title">YM</div>
        </a>
      </div>
    </div>
    <div class="body">
      <div class="content">
        使用 Certbot 申请和部署 SSL 证书 
<p>去年写过一篇文章介绍 Let’s Encrypt 免费证书，以及申请和部署的过程。最近又为站点上 HTTPS，发现官方推荐的 <a href="https://certbot.eff.org/" target="_blank" rel="noopener">Certbot</a> 客户端确实更好用，几乎全自动完成证书的申请、部署和更新。</p>
<a id="more"></a>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>首先启用 EPEL（企业版 Linux 附加软件包）源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install yum-utils</span><br><span class="line">yum-config-manager --enable rhui-REGION-rhel-server-extras rhui-REGION-rhel-server-optional</span><br></pre></td></tr></table></figure>

<p>安装 Certbot 客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install certbot-nginx</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>申请和部署 SSL 证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot --nginx</span><br></pre></td></tr></table></figure>

<p>Cerbot 将分析 Nginx 的配置文件（默认为 <code>/etc/nginx/nginx.conf</code> ），然后自动完成证书的申请和部署，包括修改 Nginx 配置文件并重启服务。这也是我之前一直遇到错误的问题所在：如果 Nginx 的安装目录不是 <code>/etc/nginx</code> ，Cerbot 找不到配置文件就会报错。</p>
<p>所以，需要使用 <code>--nginx-server-root</code> 指定配置文件的路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot --nginx --nginx-server-root&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf</span><br></pre></td></tr></table></figure>

<p>然后根据提示选择你要启用 HTTPS 的站点，等待证书部署完成。</p>
<p>如果只希望 Cerbot 申请证书但不自动部署，使用 <code>certonly</code> 子命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot --nginx certonly</span><br></pre></td></tr></table></figure>

<h3 id="续期"><a href="#续期" class="headerlink" title="续期"></a>续期</h3><p>测试证书更新命令是否正常：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot renew --dry-run</span><br></pre></td></tr></table></figure>

<p>执行 <code>crontab -e</code> 编辑任务调度文件，添加一个任务，定期检测证书的有效期并自动更换新的证书。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 5 * * * certbot renew</span><br></pre></td></tr></table></figure>

<p>相关环境：Aliyun ECS / CentOS 7 x64 / Python 2.7 / Nginx 1.12</p>
 
      </div>
    </div>
    <div class="foot">
      <div class="footer">
        <span class="copyright">©️2020 ym</span>
        <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
      </div>
    </div>
  </body>
</html>