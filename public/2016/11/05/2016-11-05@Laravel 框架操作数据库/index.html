<html>
  <head>
    <title>ym</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/app.css">
  <meta name="generator" content="Hexo 4.2.1"></head>
  <body>
    <div class="head">
      <div class="header">
        <a href="/ ">
          <div class="site-title">YM</div>
        </a>
      </div>
    </div>
    <div class="body">
      <div class="content">
        Laravel 框架操作数据库 
<p>Laravel 提供 DB Facade 、Query Builder 和 Eloquent ORM 三种操作数据库的方式。</p>
<h3 id="原始查找"><a href="#原始查找" class="headerlink" title="原始查找"></a>原始查找</h3><p>原始查找（DB Facade）直接使用 SQL 语句操作数据库。</p>
<a id="more"></a>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引用命名空间</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增，返回布尔值。</span></span><br><span class="line">$bol = DB::insert(<span class="string">'INSERT INTO users(email, password) VALUES(?, ?)'</span>, [<span class="string">'example@example.com'</span>, <span class="string">'123456'</span>]);</span><br><span class="line"><span class="comment">// 删除，返回影响行数。</span></span><br><span class="line">$row = DB::delete(<span class="string">'DELETE FROM users WHERE id = ?'</span>, [<span class="number">1</span>]);</span><br><span class="line"><span class="comment">// 修改，返回影响行数。</span></span><br><span class="line">$row = DB::update(<span class="string">'UPDATE users SET password = ? WHERE email = ?'</span>, [<span class="string">'654321'</span>, <span class="string">'example@example.com'</span>]);</span><br><span class="line"><span class="comment">// 查询，返回数组。</span></span><br><span class="line">$arr = DB::select(<span class="string">'SELECT * FROM users'</span>);</span><br></pre></td></tr></table></figure>

<p>在 SQL 语句中可以用 <code>?</code> 占位符，引用数组中参数。</p>
<h3 id="查询构建器"><a href="#查询构建器" class="headerlink" title="查询构建器"></a>查询构建器</h3><p>查询构建器（Query Builder）使用高度封装的接口操作数据库。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引用命名空间</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">DB</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增，返回布尔值。</span></span><br><span class="line">$bol = DB::table(<span class="string">'users'</span>)-&gt;insert(</span><br><span class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'example@example.com'</span>, <span class="string">'password'</span> =&gt; <span class="string">'123456'</span>]</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 新增，返回该条数据的id。</span></span><br><span class="line">$id  = DB::table(<span class="string">'users'</span>)-&gt;insertGetId(</span><br><span class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'example@example.com'</span>, <span class="string">'password'</span> =&gt; <span class="string">'123456'</span>]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除，返回影响行数。</span></span><br><span class="line">$row = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, <span class="number">1</span>)-&gt;delete();</span><br><span class="line">$row = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'id'</span>, <span class="string">'&lt;'</span>, <span class="number">3</span>)-&gt;delete();</span><br><span class="line"><span class="comment">// 清空数据表，无返回值。</span></span><br><span class="line">DB::table(<span class="string">'users'</span>)-&gt;truncate();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改，返回影响行数。</span></span><br><span class="line">$row = DB::table(<span class="string">'users'</span>)</span><br><span class="line">  -&gt;where(<span class="string">'email'</span>, <span class="string">'example@example.com'</span>)</span><br><span class="line">  -&gt;update([<span class="string">'password'</span>, <span class="string">'654321'</span>]);</span><br><span class="line"><span class="comment">// 修改，自增并返回影响行数。</span></span><br><span class="line">$row = DB::table(<span class="string">'users'</span>)-&gt;increment(<span class="string">'age'</span>);</span><br><span class="line">$row = DB::table(<span class="string">'users'</span>)-&gt;increment(<span class="string">'age'</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// 修改，自减并返回影响行数。</span></span><br><span class="line">$row = DB::table(<span class="string">'users'</span>)-&gt;decrement(<span class="string">'age'</span>);</span><br><span class="line">$row = DB::table(<span class="string">'users'</span>)-&gt;decrement(<span class="string">'age'</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// 修改，自增的同时修改字段，返回影响行数。</span></span><br><span class="line">$row = DB::table(<span class="string">'users'</span>)-&gt;increment(<span class="string">'age'</span>, <span class="number">3</span>, [<span class="string">'password'</span> =&gt; <span class="string">'654321'</span>]);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询，所有数据，返回数组。</span></span><br><span class="line">$arr = DB::table(<span class="string">'users'</span>)-&gt;get();</span><br><span class="line"><span class="comment">// 查询，第一条数据，返回对象。</span></span><br><span class="line">$obj = DB::table(<span class="string">'users'</span>)</span><br><span class="line">  -&gt;orderBy(<span class="string">'id'</span>, <span class="string">'desc'</span>)</span><br><span class="line">  -&gt;first();</span><br><span class="line"><span class="comment">// 查询，符合某一条件的所有数据，返回数组。</span></span><br><span class="line">$arr = DB::table(<span class="string">'users'</span>)</span><br><span class="line">  -&gt;where(<span class="string">'id'</span>, <span class="string">'&lt;='</span>, <span class="number">3</span>)</span><br><span class="line">  -&gt;get();</span><br><span class="line"><span class="comment">// 查询，符合多个条件的所有数据，返回数组。</span></span><br><span class="line">$arr = DB::table(<span class="string">'users'</span>)</span><br><span class="line">  -&gt;whereRaw(<span class="string">'id &lt; ? and age &gt; ?'</span>, [<span class="number">10</span>,<span class="number">20</span>])</span><br><span class="line">  -&gt;get();</span><br><span class="line"><span class="comment">// 查询，指定某一字段，返回数组。</span></span><br><span class="line">$arr = DB::table(<span class="string">'users'</span>)-&gt;pluck(<span class="string">'email'</span>);</span><br><span class="line"><span class="comment">// 查询，指定多个字段，返回数组。</span></span><br><span class="line">$arr = DB::table(<span class="string">'users'</span>)</span><br><span class="line">  -&gt;select(<span class="string">'id'</span>, <span class="string">'email'</span>, <span class="string">'name'</span>)</span><br><span class="line">  -&gt;get();</span><br><span class="line"><span class="comment">// 查询，指定字段并指定键值，返回数组。</span></span><br><span class="line">$arr = DB::table(<span class="string">'users'</span>)-&gt;lists(<span class="string">'email'</span>, <span class="string">'id'</span>);</span><br><span class="line"><span class="comment">// 查询，返回记录数。</span></span><br><span class="line">$int = DB::table(<span class="string">'users'</span>)-&gt;count();</span><br><span class="line"><span class="comment">// 查询，返回某列的最大/最小值。</span></span><br><span class="line">$num = DB::table(<span class="string">'users'</span>)-&gt;max(<span class="string">'age'</span>);</span><br><span class="line">$num = DB::table(<span class="string">'users'</span>)-&gt;min(<span class="string">'age'</span>);</span><br><span class="line"><span class="comment">// 查询，返回某列的平均值。</span></span><br><span class="line">$num = DB::table(<span class="string">'users'</span>)-&gt;avg(<span class="string">'age'</span>);</span><br><span class="line"><span class="comment">// 查询，返回某列的和。</span></span><br><span class="line">$num = DB::table(<span class="string">'users'</span>)-&gt;sum(<span class="string">'age'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="对象关系模型"><a href="#对象关系模型" class="headerlink" title="对象关系模型"></a>对象关系模型</h3><p>对象关系模型（Eloquent ORM）是在查询构建器的基础上，使用与数据表一一对应的模型类来操作数据库。</p>
<p>首先，在 app 目录下创建一个 User 模型，命名为 User.php ，它默认对应数据库的 users 表。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 指定表名，不指定默认使用类名的复数。</span></span><br><span class="line">    <span class="keyword">protected</span> $table = <span class="string">'users'</span>;</span><br><span class="line">    <span class="comment">// 指定主键。</span></span><br><span class="line">    <span class="keyword">protected</span> $primaryKey = <span class="string">'id'</span>;</span><br><span class="line">    <span class="comment">// 允许批量赋值的字段。</span></span><br><span class="line">    <span class="keyword">protected</span> $fillable = [</span><br><span class="line">        <span class="string">'name'</span>, <span class="string">'email'</span>, <span class="string">'password'</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在控制器中使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引用命名空间</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增，使用模型。</span></span><br><span class="line">$user = <span class="keyword">new</span> User();</span><br><span class="line">$user-&gt;email = <span class="string">'example@example.com'</span>;</span><br><span class="line">$user-&gt;password = <span class="string">'123456'</span>;</span><br><span class="line">$bol = $user-&gt;save();</span><br><span class="line"><span class="comment">// 新增，使用模型的create方法。</span></span><br><span class="line">User::create(</span><br><span class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'example@example.com'</span>, <span class="string">'password'</span> =&gt; <span class="string">'123456'</span>]</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 新增，当查询不到时新增一条记录，返回User对象。</span></span><br><span class="line">User::firstOrCreate(</span><br><span class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'example@example.com'</span>]</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 新增，当查询不到时创建新的对象，返回User对象。</span></span><br><span class="line">User::firstOrNew(</span><br><span class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'example@example.com'</span>]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除，使用模型。</span></span><br><span class="line">$user = User::find(<span class="number">1</span>);</span><br><span class="line">$bol = $user-&gt;delete();</span><br><span class="line"><span class="comment">// 删除，指定主键的数据。</span></span><br><span class="line">$row = User::destory(<span class="number">1</span>);</span><br><span class="line">$row = User::destory(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// 删除，符合条件的数据。</span></span><br><span class="line">$row = User::where(<span class="string">'id'</span>, <span class="string">'&lt;'</span>, <span class="number">3</span>)-&gt;delete();</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改，使用模型。</span></span><br><span class="line">$user = User::find(<span class="number">1</span>);</span><br><span class="line">$user-&gt;password = <span class="string">'654321'</span>;</span><br><span class="line">$bol = $user-&gt;save();</span><br><span class="line"><span class="comment">// 修改，使用模型的update方法。</span></span><br><span class="line">$row = User::where(<span class="string">'email'</span>, <span class="string">'example@example.com'</span>)-&gt;update(</span><br><span class="line">  [<span class="string">'password'</span> =&gt; <span class="string">'654321'</span>]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询，所有数据，返回集合。</span></span><br><span class="line">$col = User::all();</span><br><span class="line">$col = User::get();</span><br><span class="line"><span class="comment">// 查询，指定主键，返回对象。</span></span><br><span class="line">$obj = User::find(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 查询，同上，无结果时报错。</span></span><br><span class="line">$obj = User::findOrFail(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 查询，指定条件并排序。</span></span><br><span class="line">$obj = User::where(<span class="string">'id'</span>, <span class="string">'&lt;'</span>, <span class="number">3</span>)-&gt;orderBy(<span class="string">'id'</span>, <span class="string">'desc'</span>);</span><br><span class="line"><span class="comment">// 查询，第一条数据。</span></span><br><span class="line">$obj = User::all()-&gt;first();</span><br><span class="line"><span class="comment">// 查询，返回结果数。</span></span><br><span class="line">$int = User::count();</span><br><span class="line"><span class="comment">// 查询，某列的最大/最小值。</span></span><br><span class="line">$num = User::where(<span class="string">'id'</span>, <span class="string">'&lt;'</span>, <span class="number">10</span>)-&gt;max(<span class="string">'age'</span>);</span><br><span class="line">$num = User::where(<span class="string">'id'</span>, <span class="string">'&lt;'</span>, <span class="number">10</span>)-&gt;min(<span class="string">'age'</span>);</span><br></pre></td></tr></table></figure>

<p>实际上，无论使用何种方式操作数据库，最终都是在执行 SQL 语句。相较于 DB Facade ，后两者把构造 SQL 语句的工作交给了 Laravel 。另外，我感觉 Eloquent ORM 和 Query Builder 是很接近的，只不过多了模型的概念，不过后者的代码确实要更加简洁、一目了然。</p>
<p>相关环境：Windows 7 x64 / VirtualBox 5.1.8 / Laravel Homestead / Laravel 5.2</p>
 
      </div>
    </div>
    <div class="foot">
      <div class="footer">
        <span class="copyright">©️2020 ym</span>
        <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
      </div>
    </div>
  </body>
</html>