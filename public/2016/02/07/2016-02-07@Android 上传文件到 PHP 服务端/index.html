<html>
  <head>
    <title>ym</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/app.css">
  <meta name="generator" content="Hexo 4.2.1"></head>
  <body>
    <div class="head">
      <div class="header">
        <a href="/ ">
          <div class="site-title">YM</div>
        </a>
      </div>
    </div>
    <div class="body">
      <div class="content">
        Android 上传文件到 PHP 服务端 
<p>最近练习的小项目中用到了文件上传功能，从 Android 客户端向 PHP 服务端上传文件。</p>
<p>查了不少资料，看过很多 demo ，结果照搬过来都以失败告终了。经过阅读、思考和尝试后终于改出了能用的代码。</p>
<a id="more"></a>

<p>实际上实现的方法都差不多，客户端发送 POST 请求向服务端上传文件，服务端判断、接收。</p>
<p>先谈一谈几点需要特别注意的地方。</p>
<p>① SD 卡的路径要用 <code>Environment.getExternalStorageDirectory</code> 获取，因为不同手机默认的 SD 卡路径可能不同。</p>
<p>② 在每次测试之前，确保本地文件确实存在且可读，用 PC 确定服务端链接可以访问。</p>
<p>③ 客户端设置的文件键名 name 必须和服务端一致。</p>
<p>客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 文件路径 建议用 Environment.getExternalStorageDirectory 方法获取 SD 卡路径</span><br><span class="line">private String filePath &#x3D; &quot;&#x2F;sdcard&#x2F;example&#x2F;image.jpg&quot;;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 上传图片到服务端</span><br><span class="line"> * @param targetUrl 服务端链接</span><br><span class="line"> *&#x2F;</span><br><span class="line">private void uploadFile(final String targetUrl) &#123;</span><br><span class="line">  Thread thread &#x3D; new Thread() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">      String end &#x3D; &quot;\r\n&quot;;</span><br><span class="line">      String twoHyphens &#x3D; &quot;--&quot;;</span><br><span class="line">      String boundary &#x3D; &quot;******&quot;;</span><br><span class="line">      try &#123;</span><br><span class="line">        URL url &#x3D; new URL(targetUrl);</span><br><span class="line">        HttpURLConnection httpURLConnection &#x3D; (HttpURLConnection)url.openConnection();</span><br><span class="line">        &#x2F;&#x2F; 设置每次传输的流大小</span><br><span class="line">        httpURLConnection.setChunkedStreamingMode(128 * 1024); &#x2F;&#x2F;128K</span><br><span class="line">        &#x2F;&#x2F; 允许输入输出流</span><br><span class="line">        httpURLConnection.setDoInput(true);</span><br><span class="line">        httpURLConnection.setDoOutput(true);</span><br><span class="line">        httpURLConnection.setUseCaches(false);</span><br><span class="line">        &#x2F;&#x2F; 使用 POST 方法</span><br><span class="line">        httpURLConnection.setRequestMethod(&quot;POST&quot;);</span><br><span class="line">        httpURLConnection.setRequestProperty(&quot;Connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class="line">        httpURLConnection.setRequestProperty(&quot;Charset&quot;, &quot;UTF-8&quot;);</span><br><span class="line">        httpURLConnection.setRequestProperty(&quot;Content-Type&quot;,</span><br><span class="line">            &quot;multipart&#x2F;form-data;boundary&#x3D;&quot; + boundary);</span><br><span class="line">        DataOutputStream dos &#x3D; new DataOutputStream(httpURLConnection.getOutputStream());</span><br><span class="line">        dos.writeBytes(twoHyphens + boundary + end);</span><br><span class="line">        &#x2F;&#x2F; 设置 name 为 file</span><br><span class="line">        dos.writeBytes(&quot;Content-Disposition: form-data; name&#x3D;\&quot;file\&quot;; filename&#x3D;\&quot;&quot;</span><br><span class="line">            + filePath.substring(filePath.lastIndexOf(&quot;&#x2F;&quot;) + 1)</span><br><span class="line">            + &quot;\&quot;&quot;</span><br><span class="line">            + end);</span><br><span class="line">        dos.writeBytes(end);</span><br><span class="line">        FileInputStream fis &#x3D; new FileInputStream(filePath);</span><br><span class="line">        byte[] buffer &#x3D; new byte[8192]; &#x2F;&#x2F; 8k</span><br><span class="line">        int count &#x3D; 0;</span><br><span class="line">        &#x2F;&#x2F; 读取文件</span><br><span class="line">        while ((count &#x3D; fis.read(buffer)) !&#x3D; -1) &#123;</span><br><span class="line">          dos.write(buffer, 0, count);</span><br><span class="line">        &#125;</span><br><span class="line">        fis.close();</span><br><span class="line">        dos.writeBytes(end);</span><br><span class="line">        dos.writeBytes(twoHyphens + boundary + twoHyphens + end);</span><br><span class="line">        dos.flush();</span><br><span class="line">        &#x2F;&#x2F; ResponseCode 可以用来判断错误类型</span><br><span class="line">        &#x2F;&#x2F; int status &#x3D; httpURLConnection.getResponseCode();</span><br><span class="line">        InputStream is &#x3D; httpURLConnection.getInputStream();</span><br><span class="line">        InputStreamReader isr &#x3D; new InputStreamReader(is, &quot;utf-8&quot;);</span><br><span class="line">        BufferedReader br &#x3D; new BufferedReader(isr);</span><br><span class="line">        &#x2F;&#x2F; 获取返回内容</span><br><span class="line">        String info &#x3D; br.readLine();</span><br><span class="line">        dos.close();</span><br><span class="line">        is.close();</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 ROOT 为当前目录</span></span><br><span class="line">define(<span class="string">'ROOT'</span>, dirname(<span class="keyword">__FILE__</span>).<span class="string">'/'</span>);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 限制拓展名为 jpg 且文件大小在5KB以内。</span></span><br><span class="line"><span class="keyword">if</span>((pathinfo($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>], PATHINFO_EXTENSION) == <span class="string">"jpg"</span>) &amp;&amp; ($_FILES[<span class="string">"file"</span>][<span class="string">"size"</span>] &lt; <span class="number">5000</span>))&#123;</span><br><span class="line">  <span class="comment">// 上传文件失败</span></span><br><span class="line">  <span class="keyword">if</span>($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"错误代码："</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] . <span class="string">"&lt;br /&gt;"</span>; </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 上传文件成功</span></span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( !( file_exists(ROOT. $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]) ) )&#123;</span><br><span class="line">      <span class="comment">// 将临文件移动到指定路径</span></span><br><span class="line">      move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], ROOT . $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]  );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>建议先写服务端代码，确定接口可用后再用客户端发送请求。</p>
 
      </div>
    </div>
    <div class="foot">
      <div class="footer">
        <span class="copyright">©️2020 ym</span>
        <a href="http://www.beian.miit.gov.cn" target="_blank">粤ICP备20041235 </a>
      </div>
    </div>
  </body>
</html>